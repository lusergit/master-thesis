\section{Deciding invariant finiteness}\label{sec:finiteness}

\begin{lemma}\label{le:finiteness}
  If \(\com[D]\in\imp_\starless\), and \(X \in \poset{env}\) is
  finite, then \(\sem{D}X\) is finite and \(\forall \rho \in X\)
  \(\trans{\com[D]}{\rho}\ahalts\).
\end{lemma}

\begin{proof}
  By induction on the program \(\com[D]\):
  \paragraph*{Base case:\\}
  \(\com[D] \equiv e\), therefore \(\sem{e}X = \{\bsem{e}\rho \mid
  \rho \in X , \bsem{e}\rho \neq \bot\}\), which is finite, since
  \(X\) is finite. %% Moreover, by expr rule \(\forall \rho \in X\)
  %% either \(\stt{e,\rho} \to \bsem{e}\rho\) or \(\stt{e,\rho}
  %% \not\to\). In both cases \(\trans{\com[e]}{\rho} \ahalts\).
  
  \paragraph*{Inductive cases:\\}
  \begin{enumerate}
  \item \(\com[D]\equiv \com[D_1 + D_2]\), therefore \(\sem{D_1 + D_2}
    X = \sem{D_1}X \cup \sem{D_2}X\). By inductive hypothesis, both
    \(\sem{D_1}X, \sem{D_2}X\) are finite, as they're sub expressions
    of \(\com[D]\). Since the union of finite sets is finite,
    \(\sem{D_1 + D_2}X\) is finite. %% Moreover by inductive hypothesis
    %% again \(\forall \rho \in X\) \(\trans{\com[D]_1}{\rho}\ahalts\)
    %% and \(\trans{\com[D]_2}{\rho}\ahalts\). Because of sum\(_1\) and
    %% sum\(_2\) rules, \(\trans{(\com[D]_1 + \com[D]_2)}{\rho}\ahalts\).
  \item \(\com[D]\equiv \com[D_1; D_2]\), therefore \(\sem{D_1;D_2}X =
    \sem{D_2}(\sem{D_1}X)\). By inductive hypothesis \(\sem{D_1}X =
    Y\) is finite%%  and \(\forall \rho \in X\)
    %% \(\trans{\com[D]_1}{\rho}\ahalts\)
    . Again by inductive hypothesis
    \(\sem{D_2}Y\) is finite. %% and \(\forall \rho \in Y\)
    %% \(\trans{\com[D]_2}{\rho}\ahalts\).
  \end{enumerate}
\end{proof}

\begin{lemma}\label{le:infiniteness}
  Given \(\com[D]\in\imp_\starless\), and \(\{\rho\} = X \in
  \poset{env}\), the predicate "\(\sem{D^*}X\) is finite" is
  undecidable.
\end{lemma}

\begin{proof}
  Suppose we can decide \(\sem{D^*}X\) is finite. We show that we in
  that case we would be also able to decide wether
  \(\trans{\com[D]^*}{\rho}\ahalts\) for some \(\rho \in X\), which is
  undecidable.%% Let \(\rho =\envi{x_1 \mapsto a_1, \dots, x_k \mapsto
    %% a_k}\) \(X = \{\rho\}\) with \(a_1, \dots, a_k \in \z\).
  \begin{itemize}
  \item In case \(\sem{D^*}X\) is infinite, then it must be that
    \(\forall k \in \n\) \(\sem{D}^{k+1}X \nsubseteq
    \cup_{i=0}^k\sem{D}^iX\), otherwise we would reach a fixpoint
    and \(\sem{D^*}X\) would be finite. Since each application of
    \(\com[D]\) must create an unempty set of new environments we can
    build the inductive sequence of sets of environments
    \begin{align*}
      Y_0 & = X \\
      Y_{k+1} & = (\sem{D}Y_k)\setminus Y_k
    \end{align*}
    where \(\forall \rho' \in Y_{k+1} \exists \rho \in Y_k \mid \rho'
    \in \sem{D}\{\rho\}\) by definition. By lemma \ref{le:link}
    \(\rho' \in \{\rho'' \mid \stt{\com[D], \rho} \to^*
    \rho''\}\). This means that there must be at least one \(\rho_1\in
    X\) that produces an infinite path \[\stt{\com[D]^*,
      \rho_1}\to^*\stt{\com[D]^*, \rho_2}\to^*\dots \] which produces
    new environments at each application of \(\com[D]\): \(\rho_1,
    \rho_2, \dots \mid \forall i,j \in \n\) \(\rho_i \neq \rho_j\) and
    therefore \(\trans{\com[D]^*}{\rho_1} \nehalts\) which means that
    \(\trans{\com[D]^*}{\rho_1}\ahalts\) is false.
  \item In case \(\sem{D^*}X\) is finite, we can notice that for all
    the \(\rho \in X\), the states in \(\trans{\com[D]}{\rho}\)
    are \[\red{\com[D]^*}\times Y\] with
    \(Y \subseteq \{\rho'\mid \stt{\com[D], \rho} \to^* \stt{\com[D]',
      \rho'} \vee \stt{\com[D],\rho} \to^* \rho'\}\) with
    \(\com[D]'\in \red{\com[D]}\). Since there's a finite amount of
    states total termination reduces to the presence of some cycle. In
    fact if
    \begin{itemize}
    \item
      \(\exists \rho \in X \mid \stt{\com[D]^*, \rho} \to^*
      \stt{\com[D]^*, \rho'} \to^* \stt{\com[D]^*, \rho'}\) for some
      \(\rho'\in \sem{\com[D]^*}X\). In this case the semantics would
      still be finite, but there would be an infinite path
      \[\stt{\com[D]^*, \rho} \to^* \stt{\com[D]^*, \rho'} \to^*
        \stt{\com[D]^*, \rho'} \to^* \dots\] that would imply that
      \(\trans{\com[D]}{\rho} \nehalts\), and therefore
      \(\trans{\com[D]}{\rho} \ahalts\) would be false.
    \item otherwise
      \(\nexists \rho \in X \mid \stt{\com[D]^*, \rho} \to^*
      \stt{\com[D]^*, \rho'} \to^* \stt{\com[D]^*, \rho'}\) for some
      \(\rho'\in \sem{\com[D]^*}X\), but since there is a finite
      amount of states each path in \(\trans{\com[D]}{\rho}\) is
      finite, and therefore \(\trans{\com[D]}{\rho}\ahalts\).
    \end{itemize}
  \end{itemize}
\end{proof}
