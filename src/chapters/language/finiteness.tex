\section{Deciding invariant finiteness}\label{sec:finiteness}

\begin{lemma}\label{le:finiteness}
  If \(\com[D]\in\imp\starless\), and \(X \in \poset{env}\) is
  finite, then
  \begin{enumerate}[label=(\roman*).]
  \item \(\sem{D}X\) is finite;
  \item \(\forall \rho \in X\) \(\trans{\com[D]}{\rho}\ahalts\)
  \item \(\sizeof{\trans{\com[D]}{\rho}} < \infty\) for all
    \(\rho \in X\).
  \end{enumerate}
\end{lemma}

\begin{proof}
  By induction on the program \(\com[D]\):
  \paragraph*{Base case:\\}
  \(\com[D] \equiv e\), therefore
  \begin{enumerate}[label=(\roman*).]
  \item \label{it:1}
    \(\sem{e}X = \{\bsem{e}\rho \mid \rho \in X , \bsem{e}\rho \neq
    \bot\}\), which is finite, since \(X\) is finite;
  \item \label{it:2} by expr rule \(\forall \rho \in X\) either
    \(\stt{e,\rho} \to \bsem{e}\rho\) or \(\stt{e,\rho} \not\to\). In
    both cases there are no infinite paths, and therefore
    \(\trans{\com[e]}{\rho} \ahalts\);
  \item Notice that
    \(\trans{\com[e]}{\rho} = \{\tau \in \Path^\infty \mid \tau_0 =
    \stt{\com[e], \rho}\}\) for all \(\rho \in X\), therefore
    \(\sizeof{\trans{\com[e]}{\rho}} = \sizeof{X} < \infty\) because
    of \ref{it:1}
  \end{enumerate}
  
  \paragraph*{Inductive cases:\\}
  \begin{enumerate}
  \item \(\com[D]\equiv \com[D_1 + D_2]\), therefore
    \begin{enumerate}[label=(\roman*).]
    \item \(\sem{D_1 + D_2} X = \sem{D_1}X \cup \sem{D_2}X\). By
      inductive hypothesis, both \(\sem{D_1}X, \sem{D_2}X\) are
      finite, as they are sub expressions of \(\com[D]\). Since the
      union of finite sets is finite, \(\sem{D_1 + D_2}X\) is finite;
    \item by inductive hypothesis again \(\forall \rho \in X\)
      \(\trans{\com[D]_1}{\rho}\ahalts\) and
      \(\trans{\com[D]_2}{\rho}\ahalts\). Notice that
      \(\trans{\com[D]_1 + \com[D]_2}{\rho} = \{\com[D]_1 + \com[D]_2
      \circ \tau \mid \tau \in \trans{\com[D]_1}{\rho} \}\cup \{
      \com[D]_1 + \com[D]_2 \circ \tau \mid \tau \in
      \trans{\com[D]_2}{\rho} \}\) where
      \(\circ : \imp \times \Path^\infty \to \Path^\infty\) is the
      appending operator. Since we are just appending
      \(\stt{\com[D]_1 + \com[D]_2, \rho}\) in each path of the
      transition systems of \(\com[D]_1\) and \(\com[D]_2\), by
      inductive hypothesis
      \(\trans{\com[D]_1 + \com[D]_2}{\rho} \ahalts\) for all
      \(\rho \in X\).
    \item For the latter argument, since both
      \(\trans{\com[D_1]}{\rho}\) and \(\trans{\com[D_2]}{\rho}\) are
      finite and composed of finite paths
      \(\sizeof{\trans{(\com[D]_1 + \com[D]_2)}{\rho}} < \infty\).
    \end{enumerate}
  \item \(\com[D]\equiv \com[D_1; D_2]\), therefore
    \begin{enumerate}[label=(\roman*).]
    \item \(\sem{D_1;D_2}X = \sem{D_2}(\sem{D_1}X)\). By inductive
      hypothesis \(\sem{D_1}X = Y\). By inductive hypothesis again
      \(\sem{D_2}Y\) is finite;
    \item by inductive hypothesis \(\forall \rho \in X\)
      \(\trans{\com[D]_1}{\rho}\ahalts\) and again
      \(\forall \rho' \in Y\) \(\trans{\com[D]_2}{\rho'}\ahalts\);
    \item todo
    \end{enumerate}
  \end{enumerate}
\end{proof}

\begin{lemma}\label{le:infiniteness}
  Given \(\com[D]\in\imp\starless\), and \(\{\rho\} = X \in
  \poset{env}\), the predicate "\(\sem{D^*}X\) is finite" is
  undecidable.
\end{lemma}

\begin{proof}
  Suppose we can decide \(\sem{D^*}X\) is finite. We show that we in
  that case we would be also able to decide whether
  \(\trans{\com[D]^*}{\rho}\ahalts\) for some \(\rho \in X\), which is
  undecidable.%% Let \(\rho =\envi{x_1 \mapsto a_1, \dots, x_k \mapsto
    %% a_k}\) \(X = \{\rho\}\) with \(a_1, \dots, a_k \in \z\).
  \begin{itemize}
  \item In case \(\sem{D^*}X\) is infinite, then it must be that
    \(\forall k \in \n\)
    \(\sem{D}^{k+1}X \nsubseteq \cup_{i=0}^k\sem{D}^iX\), otherwise we
    would reach a fixpoint and \(\sem{D^*}X\) would be finite. Since
    each application of \(\com[D]\) must create an nonempty set of new
    environments, we can build the inductive sequence
    \begin{align*}
      Y_0 & = X \\
      Y_{k+1} & = (\sem{D}Y_k)\setminus Y_k
    \end{align*}
    where \(\forall \rho' \in Y_{k+1} \exists \rho \in Y_k \mid \rho'
    \in \sem{D}\{\rho\}\) by definition. By lemma \ref{le:link}
    \(\rho' \in \{\rho'' \mid \stt{\com[D], \rho} \to^*
    \rho''\}\). This means that there must be at least one \(\rho_1\in
    X\) that produces an infinite path \[\stt{\com[D]^*,
      \rho_1}\to^*\stt{\com[D]^*, \rho_2}\to^*\dots \] which produces
    new environments at each application of \(\com[D]\): \(\rho_1,
    \rho_2, \dots \mid \forall i,j \in \n\) \(\rho_i \neq \rho_j\) and
    therefore \(\trans{\com[D]^*}{\rho_1} \nehalts\) which means that
    \(\trans{\com[D]^*}{\rho_1}\ahalts\) is false.
  \item In case \(\sem{D^*}X\) is finite, we can notice that for all
    the \(\rho \in X\), the states in \(\trans{\com[D]}{\rho}\)
    are \[\red{\com[D]^*}\times Y\] with
    \(Y \subseteq \{\rho'\mid \stt{\com[D], \rho} \to^* \stt{\com[D]',
      \rho'} \vee \stt{\com[D],\rho} \to^* \rho'\}\) with
    \(\com[D]'\in \red{\com[D]}\). Notice that the reductions of some
    command \(\com\) are always finite, while \(Y\) is also finite:
    \(\com[D] \in \imp\starless\), therefore by lemma
    \ref{le:finiteness} \(\forall \rho \in \env\)
    \(\trans{\com[D]}{\rho} \ahalts\) and
    \(\sizeof{\trans{\com[D]}{\rho}} < \infty\). Since \(\com[D]\)
    produces a finite amount of finite paths, there is a finite amount
    of states, and therefore total termination reduces to the presence
    of some cycle. In fact if
    \begin{itemize}
    \item
      \(\exists \rho \in X \mid \stt{\com[D]^*, \rho} \to^*
      \stt{\com[D]^*, \rho'} \to^* \stt{\com[D]^*, \rho'}\) for some
      \(\rho'\in \sem{\com[D]^*}X\). In this case the semantics would
      still be finite, but there would be an infinite path
      \[\stt{\com[D]^*, \rho} \to^* \stt{\com[D]^*, \rho'} \to^*
        \stt{\com[D]^*, \rho'} \to^* \dots\] that would imply that
      \(\trans{\com[D]}{\rho} \nehalts\), and therefore
      \(\trans{\com[D]}{\rho} \ahalts\) would be false.
    \item otherwise
      \(\nexists \rho \in X \mid \stt{\com[D]^*, \rho} \to^*
      \stt{\com[D]^*, \rho'} \to^* \stt{\com[D]^*, \rho'}\) for some
      \(\rho'\in \sem{\com[D]^*}X\), but since there is a finite
      amount of states each path in \(\trans{\com[D]}{\rho}\) is
      finite, and therefore \(\trans{\com[D]}{\rho}\ahalts\).
    \end{itemize}
  \end{itemize}
\end{proof}
