\section{Deciding invariant finiteness}

\begin{lemma}\label{le:finiteness}
  If \(C\in\imp\) where the \(^*\) operator does not appear, and a
  finite \(X \in \poset{env}\) then \[\sem{C}X \text{ is finite}\]
\end{lemma}

\begin{proof}
  By induction on the program \(C\):
  \paragraph*{Base case:\\}
  \(C \equiv e\), therefore \(\sem{e}X = \{\bsem{e}\rho \mid \rho \in
  X , \bsem{e}\rho \neq \bot\}\), which is finite, since \(X\) is
  finite.
  
  \paragraph*{Inductive cases:\\}
  \begin{enumerate}
  \item \(C\equiv C_1 + C_2\), therefore \(\sem{C_1 + C_2} X =
    \sem{C_1}X \cup \sem{C_2}X\). By inductive hypothesis, both
    \(\sem{C_1}X, \sem{C_2}X\) are finite, as they're sub expressions
    of \(C\). Since the union of finite sets is finite, \(\sem{C_1 +
      C_2}X\) is finite.
  \item \(C\equiv C_1; C_2\), therefore \(\sem{C_1;C_2}X =
    \sem{C_2}(\sem{C_1}X)\). By inductive hypothesis \(\sem{C_1}X =
    Y\) is finite. Again by inductive hypothesis \(\sem{C_2}Y\) is
    finite.
  \end{enumerate}
\end{proof}

\begin{lemma}\label{le:infiniteness}
  Given \(C\in\imp\) where the \(^*\) operator does not appear, and a
  finite \(X \in \poset{env}\), the predicate "\(\sem{C^*}X\) is
  finite" is undecidable.
\end{lemma}

\begin{proof}
  Suppose we can decide weather \(\sem{C^*}X\) is finite or
  infinite. We'll show that in both cases we can decide weather
  \(C^*(a_1, \dots, a_k)\downarrow\) or \(C^*(a_1, \dots,
  a_k)\uparrow\), which we already show were undecidable statements.
  \begin{itemize}
  \item Suppose we can decide that \(\sem{C^*}X\) is infinite for some
    \(C\in\imp\) and \(X\in\poset{\env}\). Since \(\sem{C^*}X =
    \bigcup_{i\in\n}\sem{C}^i X\), \(\forall i \in \n \sem{C}^i X
    \equiv \sem{\underbrace{C;C;\dots;C}_{i\text{ times}}}X\) is
    finite because of lemma \ref{le:finiteness}. The only way we could
    end up with an infinite amount of states is by resulting in an
    infinite amount of different collections of environments for each
    \(C\) application. In other words \(\nexists i,j \in \n \mid
    \sem{C}^i X = \sem{C}^{i+j}X\) and therefore \(\forall i,j\in\n
    \{\rho_t \in \env \mid \rho \in X , \stt{C^i, \rho} \to^* \rho_t\}
    \neq \{\rho_t \in \env \mid \rho \in X , \stt{C^{i+j}, \rho} \to^*
    \rho_t\}\). Therefore \(C^*(a_1, \dots, a_k)\uparrow\).
  \item If we know instead that \(\sem{C^*}X\) is finite, we have 2
    subcases:
    \begin{enumerate}
    \item \(\exists i \in\n \mid \sem{C}^iX = \sem{C}^{i+1}X\), which
      means that by kleene iteration we reach the \(\lub\) after a
      finte amount of applications of \(C\), therefore \(C^*(a_1,
      \dots, a_k)\downarrow\).
    \item \(\exists i,j \in \n, j > 1 \mid \sem{C}^iX = \sem{C}^{i +
      j}X\) which means that by kleene iteration we do not reach the
      \(\lub\) after a finite amount of iterations, but we cycle
      trough a finite amount of different collections of states \(X_1,
      X_2, \dots, X_k\): \[\sem{C}^iX \neq \sem{C}^{i+1}X \wedge
      \sem{C}^iX = \sem{C}^{i+j}X\] in this case \(C(a_1, \dots,
      a_k)\uparrow\).
    \end{enumerate}

    Either way, we can decide weather \(C^*(a_1, \dots, a_k)
    \downarrow\) or \(C^*(a_1, \dots, a_k) \uparrow\) which are two
    undecidable statements.
  \end{itemize}
\end{proof}
