% !TeX root = mod.tex
\section{Computing interval semantics}
\label{sec:computingint}

Lemma~\ref{le:inc} provides an effective algorithm for computing the abstract
semantics of commands provided a domain that respects properties \ref{inc:hp1}
and \ref{inc:hp2}. The goal of the following section is to ensure that such
properties are respeted by intervals, and show that the semantics
computed on a finite sublattice of \(\Int\) (with no infinite
ascending chains) effectively coincides with the semantics computed in
the original \(\Int\) complete lattice, which instead contains
infinite ascending chains.
% First consider \(\tuple{\z, \leq}\)
% (\(\z\) with the usual ordering) and the max function
% \(\max : \Int \to \z\) defined as follows
% \begin{align*}
%   \max(\bot) & = -\infty \\
%   \max(\interval{a}{b}) & = b
% \end{align*}

\begin{observation}[\ref{inc:hp1} holds on intervals]
  Let \(\iota \in \Int, S \in \Int\) and let
  \({\abstr[\Int] : \poset{\z} \to \Int}\) be the abstraction map for
  the interval domain. 
  \begin{equation*}
    \left(\max(S) = \infty\right) \land \left(\iota \sqcap S \neq \bot\right)
    \Rightarrow max(\iota \sqcap \abstr[\Int](S)) = \max(\iota)
  \end{equation*}
  where \(S \in \poset{\Z}\) and \(\iota \in \Int\)
\end{observation}

\begin{proof}
  Let \(\iota = \interval{a}{b}\) and
  \(\abstr[\Int](S) = \interval{c}{\infty}\) and remember that
  \({\iota \sqcap \abstr(S) \neq \bot}\). Then
  \begin{equation*}
    \max([a,b] \sqcap \abstr[\Int](S)) = \max(\interval{\max\{a, c\}}{\min\{b , \infty\}}) = b = \max(\iota) \qedhere
  \end{equation*}
\end{proof}

\begin{observation}[\ref{inc:hp2} holds on intervals]
  Let \(\iota, \kappa \in \Int\), then
  \(\max(\iota \sqcup \kappa) = \max\{\max(\iota), \max(\kappa)\}\)
\end{observation}

\begin{proof}
  Let \(\iota = \interval{a}{b}\) and \(\kappa =
  \interval{c}{d}\). Then by definition
  \(\iota \sqcup \kappa = \interval{\min\{a,c\}}{\max\{b,d\}}\), and
  therefore
  \begin{equation*}
    \max(\iota \sqcup \kappa) = \max\{b,d\} = \max\{\max(\iota), \max(\kappa)\} \qedhere
  \end{equation*}
\end{proof}

% Now we can also observe that the hypothesis hold if we consider
% \(\tuple{\z,\geq}\), i.e., \(\z\) with the inverse ordering and a
% modified max function \(\max : \Int \to \z\) defined as follows

% \begin{align*}
%   \max(\bot) & = -\infty \\
%   \max(\interval{a}{b}) & = a \\
% \end{align*}

% i.e., the \(\min\) function. In this we also have to consider the
% \(-\) operation instead of the \(+\) operation, in order to accomodate
% for the reverse ordering.
 
% % Non Ã¨ un corollario, dovrebbe essere integrato sopra
% \begin{corollary}\label{co:inc}
%   if \(\min(\semi{\com}\eta\var[y]) \neq -\infty\) and
%   \(\min(\semi{\com}\eta\var[y]) < \lbound{\com}\) then there exists a
%   variable \(\var[z] \in\Var\) and an integer \(h\in\z\) such that
%   \(|h| \geq \lbound{\com}\) and the following two properties hold:
%   \begin{enumerate}[label=(\roman*)]
%   \item \(\min(\semi{\com}\eta\var[y]) = \min(\eta\var[z]) - h\)
%   \item for all \(\eta'\in \bA\), if \(\eta' \sqsupseteq \eta\) then
%     \(\min(\semi{\com}\eta'\var[y]) \leq \min(\eta'\var[z]) - h\)
%   \end{enumerate}
% \end{corollary}

% \begin{proof}
%   \todo[inline]{da finire}
% \end{proof}

This means that we can apply Lemma~\ref{le:inc} on the intervals
domain \(\inte\).  First, given a command \(\com\), the corresponding
finite set of variables \(\Var_{\com} \veq \varsof{\com}\), and an
interval environment \(\rho : \Var_{\com} \to \Int\), we define both
the \(\min\) and the \(\max\) value of an interval environment:
\begin{align*}
\max(\rho) & \veq \max \{ \max(\rho(\var)) \mid \var \in \Var_{\com}\} \\
\min(\rho) & \veq \max \{ \min(\rho(\var)) \mid \var \in \Var_{\com}\}
\end{align*}

% 
Then, when computing \(\semi[\inte]{\com} \rho\) on such \(\rho\)
having a finite domain, we can restrict to an interval domain bounded
by some constant \(k\in\n\) s.t.
\(\binte{k_1}{k_2} \veq (\Var_{\com} \to \bInt{k_1}{k_2}) \cup \{\top, \bot\}\)
where
\begin{align*}
  \bInt{k_1}{k_2} & \veq \{ \interval{a}{b} \mid a, b \in \z \; \land \; k_1 \leq a \leq b \leq k_2\} \\
                  & \phantom{\veq} \cup \{\interval{a}{+\infty} \mid a \in \z \; \land \; a \geq k_1\} \\
                  & \phantom{\veq} \cup \{\interval{-\infty}{b} \mid b \in \z \; \land \; b \leq k_2\}
\end{align*}

We can visualize the Hasse diagram of the bounded integer domain in
Figure~\ref{fig:bound} and notice that there are no infinite ascending
chains by definition.
% 
\begin{figure}
  \centering
  \begin{tikzpicture}
    \tikzset{node distance = .5cm}
    \node (top) {\(\top\)};
    \node (p1) [below=of top] {};
    \node (1) [left=of p1]{\(\interval{k_1}{+\infty}\)};
    \node (2) [right=of p1]{\(\interval{-\infty}{k_2}\)};
    \node (4) [below=of p1]{\(\interval{k_1}{k_2}\)};
    \node (p2) [left=of 4]{};
    \node (p3) [right=of 4]{};
    \node (3) [left=of p2]{\(\interval{k_1 + 1}{+\infty}\)};
    \node (5) [right=of p3]{\(\interval{-\infty}{k_2 - 1}\)};
    \node (p4) [below=of 4]{};
    \node (6) [left=of p4]{\(\interval{k_1 + 1}{k_2}\)};
    \node (pp1) [left=of 6]{};
    \node (d1) [left=of pp1]{\(\dots\)};
    \node (7) [right=of p4]{\(\interval{k_1}{k_2 - 1}\)};
    \node (pp2) [right=of 7]{};
    \node (d2) [right=of pp2]{\(\dots\)};
    \node (9) [below=of p4]{\(\interval{k_1 + 1}{k_2 - 1}\)};
    \node (p5) [left=of 9]{};
    \node (8) [left=of p5]{\(\interval{k_1 + 2}{k_2}\)};
    \node (p6) [right=of 9]{};
    \node (10) [right=of p6]{\(\interval{k_1}{k_2 - 2}\)};
    \node (d3) [left=of 8]{\(\dots\)};
    \node (d4) [right=of 10]{\(\dots\)};
    \node (vdot1) [below=of d3]{\(\vdots\)};
    \node (vdot2) [below=of d4]{\(\vdots\)};
    \node (dbot) [below=of 9]{\(\dots\)};
    \node (pbot2) [left=of dbot]{};
    \node (pbot1) [left=of pbot2]{};
    \node (pbot3) [right=of dbot]{};
    \node (pbot4) [right=of pbot3]{};
    \node (bot) [below=of dbot]{\(\bot\)};

    \draw
    (top) edge (1) edge (2)
    (1) edge (3) edge (4)
    (2) edge (4) edge (5)
    (3) edge (6) edge (d1)
    (4) edge (6) edge (7)
    (5) edge (7) edge (d2)
    (d1) edge (d3) edge (8)
    (6) edge (8) edge (9)
    (7) edge (9) edge (10)
    (d2) edge (10) edge (d4)
    (9) edge (dbot)
    (d3) edge (pbot1)
    (8) edge (pbot2)
    (10) edge (pbot3)
    (d4) edge (pbot4)
    (d4) edge (vdot2)
    (d3) edge (vdot1)
    (dbot) edge (bot)
    (vdot1) edge (bot)
    (vdot2) edge (bot);
  \end{tikzpicture}
  \caption{\(\bInt{k_1}{k_2}\) Hasse diagram}
  \label{fig:bound}
\end{figure}
%
First we can notice that based on the values of \(k_1\) and \(k_2\) we
have a complete lattice of interval subdomains, whose top element is
the \(\inte\) domain itself. We can define a notion of order for the
lattices by overloading the \(\sqsubseteq\) symbol in the following
way

\begin{definition}
  For all \(\bInt{k_1}{k_2}, \bInt{k_3}{k_4}\) bounded interval
  domains
  \begin{equation*}
    \bInt{k_1}{k_2} \sqsubseteq \bInt{k_3}{k_4} \iff \interval{k_1}{k_2} \sqsubseteq \interval{k_3}{k_4}
  \end{equation*}
  \noindent
  Dually, for all \(\binte{k_1}{k_2}, \binte{k_3}{k_4}\) bounded
  interval domains
  \begin{equation*}
    \binte{k_1}{k_2} \sqsubseteq \binte{k_3}{k_4} \iff \bInt{k_1}{k_2} \sqsubseteq \bInt{k_3}{k_4}
    \left(\iff \interval{k_1}{k_2} \sqsubseteq \interval{k_3}{k_4} \right)
  \end{equation*}
\end{definition}

Notice that because of the latter definition
\(\binte{k_1}{k_2} \sqsubseteq \inte\) for all \(k_1, k_2 \in \z\)
s.t.\ \(k_1 \leq k_2\). By calling
\(\inte_b = \{\binte{i}{j} \mid i,j \in \z \; \land \; i \leq j\} \cup
\{\inte, \bot\}\) we can notice that \(\tuple{\inte_b, \sqsubseteq}\)
is a complete lattice.

\noindent
We need however a special bound, based on Lemma~\ref{le:inc}, based on
the program we are considering and the initial environment.  Hence we
define \(\inte_{\com,\rho}\) as
\({\inte_{\com,\rho} = (\Var_{\com} \to \Int_{\com,\rho}) \cup \{
  \top, \bot \}}\) where
\begin{align*}
  \Int_{\com,\rho} & \veq \{ \interval{a}{b} \mid a, b \in \n \land
                     \min(\rho) - \lbound{\com} \leq a \leq b \leq \max(\rho) + \bound{\com}\} \\
                   & \phantom{\veq} \cup \{\interval{a}{+\infty} \mid a \in\z \; \land \; a \geq \min(\rho) - \lbound{\com}\} \\
                   & \phantom{\veq} \cup \{\interval{-\infty}{b} \mid b \in\z \; \land \; b \leq \max(\rho) + \bound{\com}\} \\
                   & = \bInt{\min(\rho)-\lbound{\com}}{\max(\rho) + \bound{\com}}
\end{align*}

We preliminarly observe that for any given \(k_1,k_2\in\n\) the
lattice \(\binte{k_1}{k_2}\) is a sub-lattice of \(\inte\)
\begin{align*}
  \eta \sqcup \theta & \in \binte{k_1}{k_2} & \forall \eta,\theta \in \binte{k_1}{k_2} \\
  \eta \sqcap \theta & \in \binte{k_1}{k_2} & \forall \eta,\theta \in \binte{k_1}{k_2}
\end{align*}

i.e., they are closed under \(\sqcap\) and \(\sqcup\). In fact if we
consider \({\eta = \interval{a}{b} \in \binte{k_1}{k_2}}\) and
\({\theta = \interval{c}{d} \in \binte{k_1}{k_2}}\) by definition both
\(b,d \leq k_2\) and \(a,c \geq k_1\). Now consider
\({\eta \sqcup \theta = \interval{\min\{a,c\}}{\max\{b,d\}}}\), where
we can observe \(\max\{b,d\} \leq k_2\) and \(\min\{a,c\} \geq k_1\)
and therefore \({\eta \sqcup \theta \in \binte{k_1}{k_2}}\) by
definition of \(\binte{k_1}{k_2}\).  Also observe that if
\(\eta \sqcap \theta \neq \bot\) then
\({\eta \sqcap \theta = \interval{\max\{a,c\}}{\min\{b,d\}}}\) and it
holds that \({\min\{b,d\} \leq k_2}\) and \({\max\{a,c\} \geq k_1}\)
and therefore \({\eta \sqcap \theta \in \binte{k_1}{k_2}}\) by definition of
\(\binte{k_1}{k_2}\).

\medskip

\noindent
Special attention must be put in defining what the analysis over a
bounded interval domain is. In particular, let's first define our
abstraction and concretization maps

\begin{definition}\label{def:boundedac}
  Let \(k_1, k_2\in\n\). The abstraction map
  \({\abstr[\bInt{k_1}{k_2}] : \poset{\z} \to \bInt{k_1}{k_2}}\) is
  defined as follows
  \begin{align*}
    \abstr[\bInt{k_1}{k_2}](\emptyset) & \defin \bot \\
    \abstr[\bInt{k_1}{k_2}](P) & \defin \begin{cases}
      \interval{\min(P)}{\max(P)} & \text{if } \max(P) \leq k_2 \text{ and } \min(P) \geq k_1\\
      \interval{\min(P)}{+\infty} & \text{if } \max(P) > k_2 \text{ and } \min(P) \geq k_1 \\
      \interval{-\infty}{\max(P)} & \text{if } \min(P) < k_1 \text{ and } \max(P) \leq k_2 \\
      \interval{-\infty}{+\infty} & \text{otherwise}
    \end{cases}
  \end{align*}
  Where \(P\in\poset{\z}\). While the concretization map
  \({\concr[\bInt{k_1}{k_2}] : \bInt{k_1}{k_2} \to \poset{\z}}\)
  actually coincides with the concretization map \(\concr[\Int]\) as
  \(\bInt{k_1}{k_2}\) is a sublattice of \(\Int\).
\end{definition}

Let's also redefine the \(+\) operation in the \(\bInt{k_1}{k_2}\)
lattice, as adding a constant to an interval with the old definition
might overcome the bound, and therefore diverge

\begin{definition}\label{def:sumbound}
  For a nonempty interval \(\interval{a}{b} \in \bInt{k_1}{k_2}\) and
  \(c \in \n\) define
  \begin{equation*}
    \interval{a}{b} \pm c \veq \begin{cases}
      \interval{a\pm c}{b\pm c} & a \pm c \geq k_1 \land b \pm c \leq k_2 \\
      \interval{a\pm c}{+\infty} & b \pm c \geq k_2 \\
      \interval{-\infty}{b \pm c} & a \pm c \leq k_1
    \end{cases}
  \end{equation*}
  recalling that \(\pm \infty + c = \pm\infty - c = \pm\infty\).
\end{definition}

\begin{lemma}\label{le:leq}
  for all \(k_1, k_2\in\z\) s.t. \(k_1 \leq k_2\)
  \begin{equation*}
    \semi[\inte]{\com}\rho \sqsubseteq \semi[\binte{k_1}{k_2}]{\com}\rho
  \end{equation*}
  i.e., with \(\binte{k_1}{k_2}\) we have an over-approximation of \(\inte\).
\end{lemma}

\begin{proof}
  The proof works by induction on \(\com\). Let's therefore first work
  on the base cases.

  \medskip

  \noindent
  \textbf{Case} (\(\var \in S\)).
  % 
  Recall that
  \(\semi[\inte]{\var\in S}\rho = \rho[\var \mapsto {\rho\var \sqcap
    \abstr[\Int](S)}]\). Hence we have two cases:
  \begin{itemize}
  \item \({\rho\var \sqcap \abstr[\Int](S)} = \bot\). In this case it
    holds that
    \begin{equation*}
      \semi[\inte]{\var\in S}\rho = \bot \sqsubseteq \semi[\binte{k_1}{k_2}]{\var\in S}\rho
    \end{equation*}
    
  \item \({\rho\var \sqcap \abstr[\Int](S)} = \interval{a}{b}\) for
    some \({a \in \n \cup \{-\infty\}}, {b \in
      \n\cup\{+\infty\}}\). In this case notice that because of
    \(\abstr[\bInt{k_1}{k_2}]\) definition, it holds that
    \begin{equation*}
      \abstr[\Int](S) \sqsubseteq \abstr[\bInt{k_1}{k_2}](S)
    \end{equation*}
    and therefore
    \({\rho\var \sqcap \abstr[\Int](S)} \sqsubseteq {\rho\var \sqcap
      \abstr[\bInt{k_1}{k_2}](S)}\). Hence
    \begin{equation*}
      {\semi[\inte]{\var\in S}\rho} \sqsubseteq {\semi[\binte{k_1}{k_2}]{\var\in S}\rho}
    \end{equation*}
    which is our thesis.
  \end{itemize}

  \medskip

  \noindent
  \textbf{Case} (\(\var := k\)).
  % 
  Let's recall that
  \({\semi[\inte]{\var := k}\rho = \rho[\var \mapsto
    \abstr[\Int](\{k\})]}\) and since
  \({\abstr[\Int](\{k\})} \sqsubseteq {\abstr[\bInt{k_1}{k_2}](\{k\})}\) it holds
  that
  \begin{equation*}
    \semi[\inte]{\var := k}\rho \sqsubseteq \semi[\binte{k_1}{k_2}]{\var := k}\rho
  \end{equation*}
  which is our thesis.

  \medskip

  \noindent
  \textbf{Case} (\(\var := \var[y] + k\)).
  % 
  Recall again that
  \({\semi[\inte]{\var := \var[y] + k}\rho} = {\rho[\var \mapsto
    \rho\var[y] + k]}\). Also recall that
  \begin{equation*}
    \iota +_{\Int} j \sqsubseteq \iota +_{\bInt{k_1}{k_2}} j
  \end{equation*}
  where \(\iota \in \bInt{k_1}{k_2} \subseteq \Int\), \(j\in\n\),
  i.e., \(\rho\var[y] + j\) in \(\Int\) is more precise than
  \(\rho\var[y] + j\) in \(\bInt{k_1}{k_2}\). Hence it holds that
  \begin{equation*}
    {\semi[\inte]{\var := \var[y] + k}\rho} \sqsubseteq {\semi[\binte{k_1}{k_2}]{\var := \var[y] + k}\rho}
  \end{equation*}
  which is our thesis.

  \medskip
  \noindent
  Now, we can work on the inductive cases.

  \medskip

  \noindent
  \textbf{Case} (\(\com_1 \ndet \com_2\)).
  % 
  Recall that
  \({\semi[\inte]{\com_1 \ndet \com_2}\rho} =
  {\semi[\inte]{\com_1}\rho} \ndet {\semi[\inte]{\com_2}\rho}\). By
  inductive hypothesis
  \({\semi[\inte]{\com_1}\rho} \sqsubseteq
  {\semi[\binte{k_1}{k_2}]{\com_1}\rho}\) and
  \({\semi[\inte]{\com_2}\rho} \sqsubseteq
  {\semi[\binte{k_1}{k_2}]{\com_2}\rho}\). Hence we can conclude by noticing
  that \(\binte{k_1}{k_2}\) is closed under \(\sqcup\)
  \begin{equation*}
    \semi[\inte]{\com_1 \ndet \com_2}\rho \sqsubseteq
    \semi[\binte{k_1}{k_2}]{\com_1}\rho \sqcup \semi[\binte{k_1}{k_2}]{\com_2}\rho =
    \semi[\binte{k_1}{k_2}]{\com_1 \sqcup \com_2}\rho
  \end{equation*}

  \medskip

  \noindent
  \textbf{Case} (\(\com_1 \seq \com_2\)).
  % 
  Recall that
  \({\semi[\inte]{\com_1 \seq \com_2}\rho} =
  {\semi[\inte]{\com_2}\left(\semi[\inte]{\com_1}\rho\right)}\). By
  inductive hypothesis
  \begin{equation}\label{eq:a1}
    {\semi[\inte]{\com_1}\rho} \sqsubseteq {\semi[\binte{k_1}{k_2}]{\com_1}\rho}
  \end{equation}
  We can call \(\rho' = {\semi[\binte{k_1}{k_2}]{\com_1}\rho}\) and observe
  that by inductive hypothesis
  \begin{equation}\label{eq:a2} {\semi[\inte]{\com_2}\rho'}
    \sqsubseteq {\semi[\binte{k_1'}{k_2'}]{\com_2}\rho'}
  \end{equation}
  for all \(k_1',k_2'\in\n\). We can conclude by
  \begin{align*}
    {\semi[\inte]{\com_2}\left(\semi[\inte]{\com_1}\rho\right)} & \sqsubseteq {\semi[\binte{k_1}{k_2}]{\com_2}\left(\semi[\inte]{\com_1}\rho\right)} & \text{by \eqref{eq:a2}}\\
                                                                & \sqsubseteq {\semi[\binte{k_1}{k_2}]{\com_2}\left(\semi[\binte{k_1}{k_2}]{\com_1}\rho\right)} & \text{by \eqref{eq:a1} and monotonicity}
  \end{align*}
  which is our thesis

  \medskip

  \noindent
  \textbf{Case} (\(\fix{\com}\)).
  % 
  Recall that
  \(\fix{\com} = {\lfp(\lambda \mu . (\rho \sqcup
    \semi[\inte]{\com}\mu))}\), which again coincides with
  \({\lfp(\lambda \mu . (\mu \sqcup \semi[\inte]{\com}\mu))}\) above
  \(\rho\). i.e., we can build the chain of iterands
  \begin{align*}
    \rho_0 & \defin \rho \\
    \rho_{i+1} & \defin \semi[\inte]{\com}\rho_i \sqcup \rho_i = \semi[\inte]{\com \ndet \tru}\rho_i
  \end{align*}
  and the analysis becomes
  \({\semi[\inte]{\fix{\com}}\rho} =
  {\textstyle\bigsqcup_{i\in\n}\rho_i} =
  {\textstyle\bigsqcup_{i\in\n}\left(\semi[\inte]{\com \ndet
        \tru}\right)^i\rho}\).  For each iterand, the inductive
  hypothesis works for \(\com\) and for \(\tru\), and therefore it
  works for \(\com \ndet \tru\). Now we can use an inductive argument
  on \(i\) to state that for all \(i \in\n\)
  \begin{equation*}
    {\left(\semi[\inte]{\com\ndet\tru}\right)^i\rho} \sqsubseteq {\left(\semi[\binte{k_1}{k_2}]{\com\ndet\tru}\right)^i\rho}
  \end{equation*}
  Hence, by closure of \(\binte{k_1}{k_2}\) over \(\sqcup\)
  \begin{equation*}
    {\semi[\inte]{\fix{\com}}} =
    {\textstyle\bigsqcup_{i\in\n}\left(\semi[\inte]{\com\ndet\tru}\right)^i \rho}
    \quad \sqsubseteq \quad
    {\textstyle\bigsqcup_{i\in\n}\left(\semi[\binte{k_1}{k_2}]{\com\ndet\tru}\right)^i \rho} =
    {\semi[\binte{k_1}{k_2}]{\fix{\com}}}
  \end{equation*}

\end{proof}
With this consideration we can now proceed to prove that the analysis
on our bounded lattice \(\inte_{\com,\rho}\) produces the same result
as the analysis on \(\inte\).

% Galois connection??

% We could also operate uniformly on all commands, defining the
% semantics for \(\com\) in a domain with intervals bounded by
% \(\max(\rho) +\bound{\com}\)

\begin{theorem}
  Let \(\com\in \imp\) be a command. Then, for all finitely supported
  \(\rho : \Var \to \Int\), and \(k_1, k_2\in \z\) s.t.
  \(\inte_{\com,\rho} \sqsubseteq \binte{k_1}{k_2} \)
  \begin{equation*}
    \semi[\inte]{\com}\rho = \semi[\binte{k_1}{k_2}]{\com}\rho
  \end{equation*}
  i.e., the abstract semantics \(\semi{\com} \rho\)
  % 
  % \semi{\fix{\com}} \rho & = \lfp{\lambda \rho'. (\semi{\com} \rho')
  % \sqcup \rho}
  computed in \(\inte\) and in \(\binte{k_1}{k_2}\) coincide.
\end{theorem}

\begin{proof}

  The proof will proceed by induction on the command \(\com\). We can
  preliminarly observe that in case the analysis results in the
  \(\top\) element (i.e., \({\semi[\inte]{\com}\rho = \top}\)), since
  for all \(k_1,k_2 \in \z\) it holds that
  \(\semi[\inte]{\com}\rho \sqsubseteq
  \semi[\binte{k_1}{k_2}]{\com}\rho\) by Lemma~\ref{le:leq} it
  trivially holds that \(\semi[\inte_{\com,\rho}]{\com}\rho = \top\)
  and therefore the two analysis coincide. We will therefore silently
  omit this case.  Now, let's explore the base cases.

  \medskip
  
  \noindent
  \textbf{Case} (\(\var \in S\)).
  % 
  Recall that
  \begin{equation*}
    \semi[\inte]{\var \in S}\rho = \begin{cases}
      \rho[\var \mapsto \abstr[\Int](\concr[\Int](\rho\var) \cap \concr[\Int](S))] & \text{if } \concr[\Int](\rho\var) \cap \concr[\Int](S) \neq \emptyset \\
      \bot & \text{otherwise}
    \end{cases}
  \end{equation*}
  and that
  \begin{equation*}
    \semi[\binte{k_1}{k_2}]{\var \in S}\rho = \begin{cases}

      \rho[\var \mapsto \abstr[\bInt{k_1}{k_2}](\concr[\Int](\rho\var) \cap \concr[\Int](S))] & \text{if } \concr[\Int](\rho\var) \cap \concr[\Int](S) \neq \emptyset \\
      \bot & \text{otherwise}
    \end{cases}
  \end{equation*}
  With \(k_1 \leq \min(\rho) - \lbound{\var \in S}\) and
  \(k_2 \geq \max(\rho) + \bound{\var \in S}\). We have 2 cases:
  \begin{itemize}
  \item if
    \({\concr[\Int](\rho\var) \cap \concr[\Int](S) = \emptyset}\)
    hence it holds that
    \begin{equation*}
      \semi[\inte]{\var\in S}\rho = \bot = \semi[\binte{k_1}{k_2}]{\var \in S}\rho.
    \end{equation*}
    
  \item Otherwise
    \({\concr[\Int](\rho\var) \cap \concr[\Int](S) \neq
      \emptyset}\). In this case
    \({\semi[\inte]{\var \in S}\rho = \rho[\var \mapsto \rho\var
      \sqcap \abstr[\Int](S)]}\) and we can notice that
    \(\max(\concr[\Int](\rho\var) \cap \concr[\Int](S)) \leq
    \max(\rho\var) \leq \max(\rho)\). Therefore
    \begin{align*}
      \semi[\binte{k_1}{k_2}]{\var \in S}\rho & = \rho[\var \mapsto \abstr[\bInt{k_1}{k_2}](\concr[\Int](\rho\var) \cap \concr[\Int](S))] \\
                                              & = \rho[\var \mapsto \abstr[\Int](\concr[\Int](\rho\var) \cap \concr[\Int](S))] \\
                                              & = \semi[\inte]{\var\in S}\rho
    \end{align*}
    for all \(k_1 \leq \min(\rho) - \lbound{\var \in S}\) and
    \(k_2 \geq \max(\rho) + \bound{\var\in S}\). Which is our thesis.
  \end{itemize}

  \medskip
  
  \noindent
  \textbf{Case} (\(\var := k\)).
  % 
  Let's recall that
  \({\semi[\inte]{\var := k}\rho = \rho[\var \mapsto \interval{k}{k}
    ]}\). Recall that we are considering \(\binte{k_1}{k_2}\) with
  \(k_1 \leq \min(\rho) - \lbound{\var := k}\) and
  \(k_2 \geq \max(\rho) + \bound{\var := k}\). Hence we can conclude by
  observing that
  \begin{equation*}
    \min(\rho) - \lbound{\var := k} \leq k \leq k \leq \max(\rho) + \bound{\var := k}
  \end{equation*}
  and therefore for all \(k_1 \leq \min(\rho) - \lbound{\var:=k}\) and
  \(k_2 \geq \max(\rho) + \bound{\var := k}\) it holds that
  \begin{equation*}
    \semi[\inte]{\var := k}\rho = \rho[\var \mapsto \interval{k}{k}] = \semi[\binte{k_1}{k_2}]{\var := k}\rho
  \end{equation*}
  which is our thesis.

  \medskip
  
  \noindent
  \textbf{Case} (\(\var := \var[y] + k\)).
  % 
  Let's recall that
  \({\semi[\inte]{\var := \var[y] + k}\rho = \rho[\var \mapsto
    \rho\var[y] + k]}\) and \(\bound{\var := \var[y] + k} =
  |k|\). Also remember that we are considering \(\binte{k_1}{k_2}\)
  with \(k_1 \leq \min(\rho) - \lbound{\var := \var[y] + k}\) and
  \(k_2 \geq \max(\rho) + \bound{\var := \var[y] + k}\). Notice that
  for all \(\Var \ni \var[w] \neq \var \) it holds that
  \(\rho\var[w] = \semi[\inte]{\var := \var[y] + k}\rho\var[w]\),
  hence we consider \(\var\). We have 2 cases
  \begin{itemize}
  \item
    \({\max(\semi[\inte]{\var := \var[y] + k}\rho\var)} =
    +\infty\). In this case we have 2 more cases.
    \begin{itemize}
    \item
      \({\min(\semi[\inte]{\var := \var[y] + k}\rho\var)} =
      -\infty\). In this case
      \({\semi[\inte]{\var := \var[y] + k}\rho} = \top\). Since by
      Lemma~\ref{le:leq}
      \(\semi[\inte]{\com}\rho \sqsubseteq
      \semi[\binte{k_1}{k_2}]{\com}\rho\) for all \(k_1, k_2 \in \z\)
      s.t. \(k_1 \leq k_2\), which means that
      \begin{equation*}
        \semi[\inte]{\var := \var[y] + k}\rho\var = \interval{-\infty}{+\infty} = \semi[\binte{k_1}{k_2}]{\var := \var[y] + k}\rho\var
      \end{equation*}
      in particular for all
      \(k_1 \leq \min(\rho) - \lbound{\var := \var[y] + k}\) and
      \(k_2 \geq \max(\rho) + \bound{\var := \var[y] + k}\), which is
      our thesis.
    \item
      \({\min(\semi[\inte]{\var := \var[y] + k}\rho\var)} \neq -
      \infty\). In this case by Corollary~\ref{co:inc}
      \begin{equation*}
        \min(\semi[\inte]{\var := \var[y] + k}\rho\var) = \min(\rho\var[y]) + k
      \end{equation*}
      and therefore
      \({\semi[\inte]{\var := \var[y] + k}\rho\var} =
      \interval{a}{+\infty} = {\semi[\binte{k_1}{k_2}]{\var := \var[y]
          + k}\rho\var}\) for some
      \(a \geq \min(\rho) - \lbound{\var := \var[y] + k}\), and for
      all \(k_1 \leq \min(\rho)- \lbound{\var := \var[y] + k}\) and
      \(k_2 \geq \max(\rho) + \bound{\var := \var[y] + k}\). Hence our
      thesis holds.

    \end{itemize}
  \item
    \({\max(\semi[\inte]{\var := \var[y] + k}\rho\var)} \neq
    +\infty\). In this case by Lemma~\ref{le:inc} it holds that
    \begin{equation*}
      \max(\semi[\inte]{\var:= \var[y] + k}\rho\var) = \max(\rho\var[y]) + k
    \end{equation*}
    Here we have 2 more cases depending on the value of
    \(\min(\semi[\inte]{\var:= \var[y] + k}\rho\var)\):
    \begin{itemize}
    \item
      \({\min(\semi[\inte]{\var:= \var[y] + k}\rho\var)} =
      -\infty\). In this case
      \(\semi[\inte]{\var := \var[y] + k}\rho\var[w] =
      \interval{-\infty}{b}\) with
      \(b \leq \max(\rho) + \bound{\var := \var[y] + k}\), in
      particular, because of the semantics and Lemma~\ref{le:inc} it
      holds that
      \begin{equation*}
        \semi[\inte]{\var := \var[y] + k}\rho = \rho[\var \mapsto \rho\var[y] + k] = \semi[\binte{k_1}{k_2}]{\var := \var[y] + k}\rho
      \end{equation*}
      for all \(k_1 \leq \min(\rho) - \lbound{\var := \var[y] + k}\)
      and \(k_2 \geq \max(\rho) + \bound{\var := \var[y] + k}\). Hence
      \begin{equation*}
        \semi[\inte]{\var := \var[y] + k}\rho\var[w] = \interval{-\infty}{b} = \semi[\binte{k_1}{k_2}]{\var:=\var[y]+k}\rho\var
      \end{equation*}
      which is our thesis.
      
    \item
      \({\min(\semi[\inte]{\var:= \var[y] + k}\rho\var)} \neq
      -\infty\). In this case by Corollary~\ref{co:inc} it also holds
      that
      \begin{equation*}
        \min(\semi[\inte]{\var := \var[y] + k}\rho\var) = \min(\rho\var[y]) + k
      \end{equation*}
      hence the thesis follows for all
      \(k_1 \leq \min(\rho) - \lbound{\var := \var[y] + k}\) and
      \(k_2 \geq \max(\rho) + \bound{\var := \var[y] + k}\)
      \begin{equation*}
        \semi[\inte]{\var := \var[y] + k}\rho = \rho[\var \mapsto \rho\var[y] + k] = \semi[\binte{k_1}{k_2}]{\var := \var[y] + k}\rho
      \end{equation*}
    \end{itemize}
  \end{itemize}
  
  \medskip
  \noindent
  Next, we can move to the inductive cases
  
  \medskip
  
  \noindent
  \textbf{Case} (\(\com_1 \ndet \com_2\)).
  % 
  Recall that
  \({\semi[\inte]{\com_1 \ndet \com_2}\rho} =
  {\semi[\inte]{\com_1}\rho} \sqcup {\semi[\inte]{\com_2}}\). By
  inductive hypothesis it holds that
  \begin{align*}
    {\semi[\inte]{\com_1}\rho} & = \semi[\binte{k_1}{k_2}]{\com_1}\rho & \forall k_1 \leq \min(\rho) - \lbound{\com_1} \; \land \; k_2 \geq \max(\rho) + \bound{\com_1} \\
    {\semi[\inte]{\com_2}\rho} & = \semi[\binte{k_3}{k_4}]{\com_2}\rho & \forall k_3 \leq \min(\rho) - \lbound{\com_2} \; \land \; k_4 \geq \max(\rho) + \bound{\com_2}
  \end{align*}
  in particular, it holds for all \(n,m\) s.t.
  \begin{align*}
    n & \leq \min(\rho) - \lbound{\com_1} - \lbound{\com_2} & = \min(\rho) - \lbound{\com_1 \ndet \com_2} \\
    m & \geq \max(\rho) + \bound{\com_1} + \bound{\com_2} & = \max(\rho) + \bound{\com_1 \ndet \com_2}
  \end{align*}
  and we can conclude by recalling that \(\binte{n}{m}\) is closed
  under \(\sqcup\)
  \begin{equation*} {\semi[\inte_{\com_1 \ndet \com_2,
        \rho}]{\com_1}\rho} \sqcup {\semi[\inte_{\com_1 \ndet \com_2,
        \rho}]{\com_2}\rho} = {\semi[\inte_{\com_1\ndet\com_2}]{\com_1
        \ndet \com_2}\rho}
  \end{equation*}

  \medskip
  
  \noindent
  \textbf{Case} (\(\com_1 \seq \com_2\)).
  % 
  Let's recall that
  \(\semi[\inte]{\com_1 \seq \com_2}\rho =
  \semi[\inte]{\com}\left(\semi[\inte]{\com_1}\rho\right)\). By
  inductive hypothesis it holds that
  \begin{align}
    \semi[\inte]{\com_1}\rho & = \semi[\binte{k_1}{k_2}]{\com_1}\rho & \forall k_1 \leq \min(\rho) - \lbound{\com_1} \; \land \; k_2 \geq \max(\rho) + \bound{\com_1}\tag{\dag} \\
    \semi[\inte]{\com_2}\rho' & = \semi[\binte{k_3}{k_4}]{\com_2}\rho' & \forall k_3 \leq \min(\rho') - \lbound{\com_2} \; \land \; k_4 \geq \max(\rho') + \bound{\com_2}\tag{\ddag}\label{eq:ind2}
  \end{align}
  where \(\rho' = \semi[\inte]{\com_1}\rho\). In particular notice
  that \eqref{eq:ind2} holds for all \(n,m\) s.t.
  \begin{align*}
    m & \leq \min(\rho) - \lbound{\com_1} - \lbound{\com_2} \leq \min(\rho) - \lbound{\com_2} \\
    n & \geq \max(\rho) + \bound{\com_1} + \bound{\com_2} \geq \max(\rho) + \bound{\com_2}.
  \end{align*}
  Hence
  \begin{equation*}
    \semi[\inte]{\com_1 \seq \com_2}\rho =
    \semi[\inte]{\com_2} \left( \semi[\inte]{\com_1}\rho \right) =
    \semi[\binte{m}{n}]{\com_2}\left(
      \semi[\binte{m}{n}]{\com_1}\rho \right) =
    \semi[\binte{m}{n}]{\com_1 \seq \com_2}\rho
  \end{equation*}
  which is our thesis.

  \medskip
  
  \noindent
  \textbf{Case} (\(\fix{\com}\)).
  % % per il fix(C) credo che un modo di procedere possa essere il seguente:
  % 
  % - uso come dominio I_k con k >= max(rho) + (n+2) C^b
  Let's recall that as we observed in the \(\fix{\com}\) case in
  Lemma~\ref{le:inc} that
  \({\fix{\com} = \lfp(\lambda \mu . \semi[\inte]{\com \ndet
      \tru}\mu)}\) above \(\rho\). We can therefore build the chain of
  iterands
  \begin{align*}
    \rho_0 & \defin \rho \\
    \rho_{i+1} & \defin \semi[\inte]{\com \ndet \tru}\rho_i
  \end{align*}
  Let's consider \(\binte{m}{n}\) with
  \(n \leq \min(\rho) + (v+2)\bound{\com}\) where
  \(v = |\varsof{\com}|\) and
  \(m \geq \max(\rho) + (v+2)\bound{\com}\). We can make the following
  observations for each variable \(\var[y]\in \Var_{\com}\).
  \begin{enumerate}[label=(\roman*)]
  \item if
    \({\max(\semi[\inte]{\fix{\com}}\rho\var[y]) \neq +\infty}\) and
    \({\min(\semi[\inte]{\fix{\com}}\rho\var[y]) \neq -\infty}\), then
    because of Lemma~\ref{le:inc} and Corollary~\ref{co:inc} it holds
    that
    \begin{align*}
      \max(\semi[\inte]{\fix{\com}}\rho\var[y]) & \leq \max(\rho) + \bound{\fix{\com}} \\
      \min(\semi[\inte]{\fix{\com}}\rho\var[y]) & \geq \min(\rho) - \lbound{\fix{\com}}
    \end{align*}
    and for each \(\rho_i\)
    \begin{equation*}
      \rho_i = {\left(\semi[\inte]{\com \ndet \tru}\right)}^i\rho \sqsubseteq
      \semi[\inte]{\fix{\com}}\rho = 
      \textstyle\bigsqcup_{i\in\n} {\left(\semi[\inte]{\com \ndet \tru}\right)}^i\rho
    \end{equation*}
    because of the choice of \(n\) and \(m\) we can use the inductive
    hypothesis ad say
    \begin{equation*}
      \semi[\inte]{\com \ndet \tru}\rho_i =
      \semi[\binte{m}{n}]{\com \ndet \tru}\rho_i =
      {\left(\semi[\binte{m}{n}]{\com\ndet \tru}\right)}^i\rho.
    \end{equation*}
    Hence  by closure over \(\sqcup\)
    \begin{equation*}
      \semi[\inte]{\fix\com}\rho =
      \textstyle\bigsqcup_{i\in\n} {\left(\semi[\inte]{\com}\right)}^i\rho = 
      \textstyle\bigsqcup_{i\in\n} {\left(\semi[\binte{m}{n}]{\com}\right)}^i\rho = 
      \semi[\binte{m}{n}]{\fix\com}\rho
    \end{equation*}
    
  \item\label{eq:case2} if both
    \({\max(\semi[\inte]{\fix{\com}}\rho\var[y]) = +\infty}\) and
    \({\min(\semi[\inte]{\fix{\com}}\rho\var[y]) = -\infty}\), it
    means that
    \(\semi[\inte]{\fix\com}\rho\var[y] =
    \interval{-\infty}{+\infty}\). In this case since by
    Lemma~\ref{le:leq}
    \({\semi[\inte]{\com}\rho \sqsubseteq
      \semi[\binte{i}{j}]{\com}\rho}\) for all \(i, j \in \z\)
    s.t. \(i \leq j\), it holds that
    \begin{equation*}
      \semi[\inte]{\fix\com}\rho\var[y] = \semi[\binte{k_1}{k_2}]{\fix\com}\rho\var[y]
    \end{equation*}
    for all \(k_1 \leq \min(\rho) - \lbound{\fix\com}\) and
    \(k_2 \geq \max(\rho) + \bound{\fix\com}\), hence
    \begin{equation*}
      \semi[\inte]{\fix\com}\rho\var[y] = \semi[\inte_{\fix\com,\rho}]{\fix\com}\rho\var[y]
    \end{equation*}
    which is our thesis.
    
  \item either \[{\max(\semi[\inte]{\fix\com}\rho\var[y]) = + \infty} \; \land \;
    {\min(\semi[\inte]{\fix\com}\rho\var[y]) \neq -\infty}\] or
  \[{\max(\semi[\inte]{\fix\com}\rho\var[y]) \neq + \infty} \; \land
    \; {\min(\semi[\inte]{\fix\com}\rho\var[y]) = -\infty}.\] In both
  cases the same procedure as for the case~\ref{eq:case2} can be used.
  Hence either the first or the second case happens:
  \begin{align*}
    \semi[\inte]{\fix\com}\rho\var[y] & = \interval{a}{+\infty} = \semi[\binte{k_1}{k_2}]{\fix\com}\rho \\
    \semi[\inte]{\fix\com}\rho\var[y] & = \interval{-\infty}{b} = \semi[\binte{k_1}{k_2}]{\fix\com}\rho
  \end{align*}
  for some \(a\geq \min(\rho) - \lbound{\fix\com}\),
  \(b \leq \max(\rho) + \bound{\fix\com}\), for all
  \(k_1 \leq \min(\rho) - \lbound{\fix\com}\) and
  \(k_2 \geq \max(\rho) + \bound{\fix\com}\).

  % We will consider, without loss of generality the second of the two
  % case, as the other one is holds for the same reason.  Hence
  % \({\max(\semi[\inte]{\fix\com}\rho\var[y]) = + \infty}\), which
  % means by Lemma~\ref{le:leq} that
  % \(\semi[\binte{k_1}{k_2}]{\fix\com}\rho\var[y] = +\infty\) for all
  % \(k_1 \geq \max(\rho) + \bound{\fix\com}\), in particular with
  % \(m\). Also,
  % \({\min(\semi[\inte]{\fix\com}\rho\var[y]) \neq -\infty}\), which
  % means by Corollary~\ref{co:inc}
  % \begin{equation*}
  %   \min(\semi[\inte]{\fix\com}\rho\var[y]) \geq \min(\rho) - \lbound{\fix\com}.
  % \end{equation*}
  % Observe that for all iterands \(\rho_i\) it still holds that
  % \begin{equation*}
  %   \rho_i = {\left(\semi[\inte]{\com\ndet\tru}\right)}^i\rho \sqsubseteq \semi[\inte]{\fix\com} \rho =
  %   \textstyle\bigsqcup_{i\in\n}{\left(\semi[\inte]{\com\ndet\tru}\right)}^i\rho
  % \end{equation*}
  % Hence because of our choice of \(m\) we can use the
  % inductive hypothesis and say that
  % \begin{equation*}
    
  % \end{equation*}
  \end{enumerate}
  % 
  % - osservo che
  % 
  % (i) se max([ fix(C) ] rho y) calcolato in I Ã¨ finito, per il lemma, vale
  % 
  % max([ fix(C) ] rho y) = max(rho) + fix(C)^b = max(rho) + (n+1) C^b
  % 
  % in tutti gli iterati ho che
  % 
  % rho_i = [C+id]^i rho <= [ fix(C) ] rho y 
  % 
  % e quindi per la scelta di k, sono certo che k >= max(rho_i) +
  % C^b. Pertanto posso usare l'ipotesi induttiva su C per concludere
  % che gli iterati coincidono su I e I_k
  % 
  % (ii) se max([ fix(C) ] rho y) in I infinito, dal fatto che in I_k
  % faccio una sovrapprossimazione concludo che anche il calcolo in
  % I_k da' infinito.
  % 
  % (in questo secondo caso non mi Ã¨ evidente come concludere anche
  % che il lowerbound dell'intervallo Ã¨ lo stesso, ma suppongo si
  % possa o derivi dalla trattazione duale con intervalli in Z)
\end{proof}
