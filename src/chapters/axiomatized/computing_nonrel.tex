\section{Computing non-relational collecting semantics}\label{sec:computingnonrel}

In the following section we follow the same scheme used in
\secref{sec:computing} in order to prove that we can also bound
the non relational collecting domain to ensure convergence while
obtaining the most precise interval.  To start, we rely on
Definition~\ref{def:minmax} of \(\min\) and \(\max\) values of an
abstract environment \(\rho\) to bound the non relational collecting
domain \(\bCnr\) in this way:

\begin{definition}[Bounded non relational collecting domain]
  We define
  \(\bbCnr{k_1}{k_2} \defin \Var_{\com} \to \bounded{\poset[*]{\z}}{k_1}{k_2}\) where
  \begin{equation*}
    \bposet[*]{k_1}{k_2}{\z} = \{S \subseteq \z \mid S \neq \emptyset \land \forall x \in S \quad k_1 \leq x \leq k_2\} \cup \{\top\}
  \end{equation*}
\end{definition}
Notice that contrary to \(\binte{k_1}{k_2}\) we have no way of
representing a diverging element. For bounded intervals we had the
\(\interval{a}{+\infty}\) and \(\interval{-\infty}{b}\) elements with
\(a,b\in\z\), but for arbitrary subsets of \(z\) we have to rely on a
smashed \(\top\) element.

\medskip

\noindent
We can already observe that by definition there are no infinite
ascending nor descending chains, as every chain is bounded by above
by some \(k_2 \in \z\) and below by some \(k_1\in\z\). Moreover, there
is a Galois connection between this abstract domain and its unbounded
counterpart \(\poset\z\). First let's define the concretization and
abstraction maps

\begin{definition}\label{def:abstrnrb}
  Let \(k_1,k_2\in\z\) s.t.\ \(k_1 \leq k_2\). We define a
  concretization map
  \(\concr[k_1,k_2] : \bposet[*]{k_1}{k_2}{\z} \to \poset[*]{\z}\) as
  the identity function
  \begin{equation*}
    \concr[k_1,k_2] = \id
  \end{equation*}
  similarly we define an abstraction map
  \(\abstr[k_1,k_2] : \poset[*]{\z} \to \bposet[*]{k_1}{k_2}{\z}\) in
  the following way
  \begin{equation*}
    \abstr[k_1,k_2](S) = \begin{cases}
      S & \text{if } \min(S) \geq k_1 \land \max(S) \leq k_2 \\
      \top & \text{otherwise}
    \end{cases}
  \end{equation*}
\end{definition}

\begin{lemma}
  Given \(k_1, k_2 \in \z\) s.t.\ \(k_1\leq k_2\).
  \begin{equation*}
    \tuple{\poset[*]\z, \subseteq} \galois{\abstr[k_1,k_2]}{\id} \tuple{\bposet[*]{k_1}{k_2}{\z}, \subseteq}
  \end{equation*}
  i.e.,
  \(\tuple{\abstr[k_1,k_2], \poset[*]{\z},
    {\bposet[*]{k_1}{k_2}{\z}}, \id}\) is a Galois connection.
\end{lemma} 

\begin{proof}
  The proof consists in showing that \(\concr[k_1,k_2]\) and
  \(\abstr[k_1,k_2]\) satisfy the properties of
  Theorem~\ref{th:galoisprop}:
  \begin{enumerate}[label={(\arabic*)}]
  \item\label{itemone} \(\abstr[k_1,k_2]\), \(\id\) are monotonic;
  \item\label{itemtwo} \(\id \conc \abstr[k_1, k_2]\) is extensive, i.e.,
    \(\sigma \subseteq \abstr[k_1,k_2](\sigma)\) for all
    \(\sigma \in \poset[*]{\z}\);
  \item\label{itemthree} \(\abstr[k_1,k_2] \conc\concr\) is reductive, i.e.,
    \(\abstr[k_1,k_2](\sigma_b) \subseteq \sigma_b\) for all
    \(\sigma_b \in \bposet[*]{k_1}{k_2}{\z}\).
  \end{enumerate}
  To start let's prove~\ref{itemone}. Of course \(\id\) is monotone by
  definition. For \(\abstr[k_1,k_2]\) we have to prove that given any
  \(\sigma, \tau \in \poset[*]{\z}\) s.t.\ \(\sigma \subseteq \tau\)
  it holds that
  \(\abstr[k_1,k_2](\sigma) \subseteq \abstr[k_1,k_2](\tau)\). Notice
  that since \(\sigma \subseteq \tau\) it holds that
  \(\max(\sigma) \leq \max(\tau)\) and
  \(\min(\sigma) \geq \min(\tau)\), which means by
  Definition~\ref{def:abstrnrb}
  \(\abstr[k_1,k_2]{\sigma} \subseteq \abstr[k_1,k_2]{\tau}\), which
  is our thesis.

  \medskip

  \noindent
  Both~\ref{itemtwo} and~\ref{itemthree} follow from
  Definition~\ref{def:abstrnrb}. For~\ref{itemtwo} for all
  \(\sigma \in \poset[*]{\z}\) either
  \(\abstr[k_1,k_2]({\sigma}) = \sigma\) or
  \(\abstr[k_1,k_2]({\sigma}) = \top\), hence in both cases
  \(\sigma \subseteq \abstr[k_1,k_2]({\sigma})\)
  holds. For~\ref{itemthree}, for all
  \(\sigma_b \in \bposet[*]{k_1}{k_2}{\z}\) it holds that
  \(\max(\sigma_b) \leq k_2\) and \(\min(\sigma_b) \geq k_1\), hence
  \begin{equation}\label{eq:equality2}
    \abstr[k_1,k_2]({\sigma_b}) = \sigma_b
  \end{equation}
  and therefore \(\abstr[k_1,k_2]({\sigma_b}) \subseteq \sigma_b\)
  holds.  Moreover,~\eqref{eq:equality2} means that for all
  \(\sigma_b \in \bposet[*]{k_1}{k_2}{\z}\) that
  \(\abstr[k_1,k_2] \conc \id = \id\), which means by
  Definition~\ref{def:insertion} that we formed a Galois insertion:
  \begin{equation*}
    \tuple{\poset[*]{\z}, \subseteq}
    \galoiS{\abstr[k_1,k_2]}{\id}
    \tuple{\bposet[*]{k_1}{k_2}{\z}, \subseteq}
    \qedhere
  \end{equation*}
\end{proof}
Notice that since \(\bCnr\) and \(\bbCnr{k_1}{k_2}\) are respectively
the point-wise lifting of \(\poset[*]{\z}\) and
\(\bposet[*]{k_1}{k_2}{\z}\) there is also a Galois insertion between
them:
\begin{equation*}
  \tuple{\bCnr, \ovdot\subseteq}
  \galoiS{\dabstr[k_1,k_2]}{\id}
  \tuple{\bbCnr{k_1}{k_2}, \ovdot\subseteq}
\end{equation*}
Where
\(\dabstr[k_1,k_2](\eta) = \lambda \var . \abstr[k_1,k_2](\eta\var)\).
Since we have a Galois connection between the non relational
collecting domain \(\bCnr\) and its bounded version
\(\bbCnr{k_1}{k_2}\) we can define an abstract inductive semantics
which is sound by construction:
\begin{definition}[\textbf{Abstract bounded non relational collecting semantics}]
  Let \(k_1, k_2 \in \z\) s.t.\ \(k_1\leq k_2\).  We define basic
  expressions over the bounded non relational collecting semantics
  \({\absem[\bbCnr{k_1}{k_2}]{\cdot} : \expr \to \bbCnr{k_1}{k_2} \to
    \bbCnr{k_1}{k_2}}\) as
  \begin{equation*}
    \absem[\bbCnr{k_1}{k_2}]{\com[e]} \defin \dabstr[k_1,k_2] \conc \absem[\bCnr]{\com[e]}
  \end{equation*}
  i.e.\ the best correct abstraction.
\end{definition}

\begin{lemma}[\textbf{Bounded non relational collecting is sound}]\label{le:soundnr}
  Let \(k_1, k_2 \in \z\) s.t.\ \(k_1\leq k_2\). For all
  \(\abstract\eta \in \bbCnr{k_1}{k_2}\) it holds that
  \begin{equation*}
    \left(\semnr{\com} \conc \id \right)\abstract\eta \ovdot\subseteq \left(\id \conc \bsemnr{k_1}{k_2}{\com}\right) \abstract\eta
  \end{equation*}
  i.e., \(\bsemnr{k_1}{k_2}{\cdot}\) is sound w.r.t.\ \(\semnr{\cdot}\).
\end{lemma}

\begin{proof}
  The proof follows from the fact that \(\bsemnr{k_1}{k_2}{\cdot}\) is
  defined as the bca on basic expressions over \(\bCnr\) and there is
  a Galois connection
  \begin{equation*}
    \tuple{\bCnr, \ovdot\subseteq} \galoiS{\abstr[k_1,k_2]}{\id} \tuple{\bbCnr{k_1}{k_2}, \ovdot\subseteq}
  \end{equation*}
  Hence by Lemma~\ref{le:bcainducessoundness} our thesis 
  \begin{equation*}
    \left(\semnr{\com} \conc \id \right) \abstract\eta \ovdot\subseteq \left(\id \conc \bsemnr{k_1}{k_2}{\com}\right) \abstract\eta
  \end{equation*}
  holds.
\end{proof}

By using \(k_1, k_2\) properly, we can introduce a notion of order
between bounded non relational collecting domain. More in detail,
given \(a,b,c,d \in \z\) s.t.\ \(a\leq b\) and \(c \leq d\). Then
\(\preceq\) is a relation order s.t.
\begin{equation*}
  \bbCnr{a}{b} \preceq \bbCnr{c}{d} \iff a \leq c \land d \leq b
\end{equation*}

We bounded our analysis the same way we did with interval analysis in
Definition~\ref{def:boundedint}. This initial solution however has a
problem. Consider the following code snippet:
\begin{lstlisting}[language=Imp,caption=Snippet where bounded analysis diverges from the unbounded counterpart, label=code3]
  x := 0
  y := 0
  while (x < 1)
    x := x + 1
    y := y + 2
  if (y = 1)
    x := 2
\end{lstlisting}
before entering the \textcolor{blue}{\texttt{while}} loop variables
are bounded to singleton sets
\(\var \mapsto \{0\}, \var[y] \mapsto \{0\}\). Non-relational
collecting semantics can infer for \(\var\) the set
\(\var\mapsto \{0,1\}\), since the condition to enter the loop filters
for \(\var \mapsto \{0\}\). For \(\var[y]\) however the guard does not
filter anything (since the condition is on \(\var\) and the domain is
non-relational). Hence after the loop non-relational collecting
analysis infers the set of even numbers \(\mathbb{P}\):
\(\var[y] \mapsto \mathbb{P}\). Since the set is infinite at some
point it will surely exceed the program bound, which is a number in
\(\n\). Hence the bounded analysis, after the loop can infer
\(\var\mapsto\{0,1\}, \var[y] \mapsto \top\). The last
\textcolor{blue}{\texttt{if}} is however where the two analysis
diverge (while remaining sound): the original non-relational
collecting before the \textcolor{blue}{\texttt{if}} infers
\([\var\mapsto\{0,1\}, \var[y]\mapsto\mathbb{P}]\), hence the filter
\(\var[y] = 1\) filters \(\bot\) and therefore after the
\textcolor{blue}{\texttt{if}} the invariant remains
\([\var\mapsto\{0,1\}, \var[y]\mapsto\mathbb{P}]\). The bounded
analysis however filters \([\var\mapsto\{0,1\}, \var[y]\mapsto\{1\}]\)
and threfore after the \textcolor{blue}{\texttt{if}} the inferred
invariant is \([\var\mapsto\{0,1,2\}, \var[y]\mapsto\top]\), hence
diverging. The idea is that by being non-relational and smashing all
infinite elements of \(\poset{\z}\) to \(\top\) the loss of
information does not allow to infer the correct invariant even for
variables with finite mappings.

Our guess is that it is possible to infer the precise infinite
invariant, since all the information used to generate it are
syntattically available: previous work on such matter is from James
Worrell in~\cite{Lefaucheux2024}, which however deals with Presburger
arithmetics (which are outside of scope in this thesis).

% For this reason our approach consists in smashing the \(\top\) element
% of our analysis. Remember that the original problem we want to solve
% (roughly) is the non-termination of the anlaysis,

% che accade quando l'analisi di una variabile diverge all'interno di
% un loop usando le iterazioni di kleene.

% \begin{definition}[Smashed \(\top\) non realtional collecting]
%   Let
%   \begin{equation*}
%     \bposet{k_1}{k_2}{\z} \defin \{S \subseteq \z \mid S \neq \emptyset \land \forall x \in S \quad k_1 \leq x \leq k_2\}.
%   \end{equation*}
%   We define \(\btbCnr{k_1}{k_2}\) as
%   \begin{equation*}
%     \btbCnr{k_1}{k_2} \defin (\Var \to \bposet{k_1}{k_2}{\z}) \cup \{\bot, \top\}
%   \end{equation*}
% \end{definition}

% we can build a Galois connection with \(\bbCnr{k_1}{k_2}\) for some
% fixed \(k_1, k_2 \in \z\):

% \begin{definition}
%   Let \(k_1, k_2 \in \z\) s.t.\ \(k_1 \leq k_2\),
%   \(\eta \in \bbCnr{k_1}{k_2}\) and
%   \(\overline\eta \in \btbCnr{k_1}{k_2}\). Then the abstraction map
%   \({\tabstr[k_1,k_2]} : \bbCnr{k_1}{k_2} \to \btbCnr{k_1}{k_2}\) is
%   defined as
%   \begin{equation*}
%     {\tabstr[k_1,k_2]}(\eta) = \begin{cases}
%       \top & \text{if } \exists\var\in\Var \text{ s.t. } \eta\var = \top \\
%       \eta & \text{otherwise}
%     \end{cases}
%   \end{equation*}
%   while concretization map
%   \({\tconcr[k_1,k_2]} : \btbCnr{k_1}{k_2} \to \bbCnr{k_1}{k_2}\)
%   is defined as
%   \begin{align*}
%     \tconcr[k_1,k_2](\top) & = \lambda \var \in \Var . \top \\
%     \tconcr[k_1,k_2](\overline\eta) & = \overline\eta
%   \end{align*}
% \end{definition}

% We can now define base expressions based on the bca with the bounded
% non relational collecting semantics:

% \begin{definition}
%   Let \(\com[e] \in \expr\). The semantics of base expressions over
%   \(\btbCnr{k_1}{k_2}\) is defined as
%   \begin{equation*}
%     \absem[\btbCnr{k_1}{k_2}]{\com[e]} \defin {\tabstr[k_1,k_2]}\conc \absem[\bbCnr{k_1}{k_2}]{\com[e]}
%   \end{equation*}
%   i.e., the bca on the semantics of base expressions on bounded
%   non-relational collecting analysis.
% \end{definition}
% Once again, \(\semi[\btbCnr{k_1}{k_2}]{\cdot}\) is defined accordingly
% to the abstract inductive semantics of Definition~\ref{def:abstrsem}.
% Notice that contrary to latter definition of \(\bbCnr{k_1}{k_2}\) in
% this case we have a smashed top element. The idea is that whenever a
% variable divergeswe would conclude that the whole precise analysis
% diverges, in order to solve Problem~\ref{problem1} and decide analysis
% termination.  For simplicity, from now on we will refer to
% \(\semi[\btbCnr{k_1}{k_2}]{\cdot}\) as \(\bsemnr{k_1}{k_2}{\cdot}\).

\begin{theorem}
  Let \(\com\in\imp\) be a program. Then, for all finitely supported
  \(\eta : \Var_{\com} \to \bCnr\) and \(k_1, k_2 \in \z\) s.t.\
  \(\bCnr_{\com,\eta} \preceq \bbCnr{k_1}{k_2}\), i.e.,
  \(k_1 \leq \min(\eta) - \nlbound{\com}\) and
  \(k_2 \geq \max(\eta) + \nbound{\com}\) then
  \begin{equation*}
    \forall \var\in\Var \; \bsemnr{k_1}{k_2}{\com}\eta\var \neq \top
    \quad
    \implies
    \quad
    \semnr{\com}\eta = \bsemnr{k_1}{k_2}{\com}\eta
  \end{equation*}
  i.e., if the analysis over \(\bCnr\) for all the variables \(\var\)
  does not diverge, then the analysis over \(\bbCnr{k_1}{k_2}\)
  converges to the same result.
\end{theorem}

\begin{proof}
  The proof will proceed by induction on the program \(\com\),
  covering first the base cases of \(\expr\) expressions and then the
  inductive cases of \(\imp\). Notice that because of
  Lemma~\ref{le:soundnr}
  \begin{equation*}
    \semnr{\com} \eta \ovdot\subseteq \bsemnr{k_1}{k_2}{\com}\eta
    % \ovdot\subseteq \tconcr[k_1,k_2]\left(\bsemnr{k_1}{k_2}{\com}\eta\right)
  \end{equation*}
  already holds for every \(k_1, k_2 \in \z\) s.t.\ \(k_1\leq k_2\),
  hence what we have to prove for every case is that
  \begin{equation*}
    \forall \var\in\Var \; \bsemnr{k_1}{k_2}{\com}\eta\var \neq \top \implies \semnr{\com} \eta \var \ovdot\supseteq \bsemnr{k_1}{k_2}{\com}\eta\var \quad \forall \var\in\Var
  \end{equation*}
  \begin{inductive}
    \case{\(\var\in I\)} In this case we have to prove that
    \begin{equation*}
      \forall \var[y] \in \Var_{\com} \quad \bsemnr{k_1}{k_2}{\var\in I}\eta\var[y] \neq \top \implies \semnr{\var\in I}\eta \var[y] \ovdot\supseteq \bsemnr{k_1}{k_2}{\var\in I}\eta\var[y]
    \end{equation*}
    with \(k_1\leq \min(\eta) - \nlbound{\var \in I}\) and
    \(k_1\geq \max(\eta) + \nbound{\var \in I}\). Notice that since
    \(\semnr{\var \in I}\eta\) updates only the variable \(\var\), the
    only case we are interested in is when \(\var[y] = \var\). This
    applies also for next base cases, hence we will omit this
    observation in future base cases.

    \medskip

    \noindent
    Hence we have 2 cases. Either
    \(\eta\var \cap \concr[\inte](I) = \emptyset\), hence
    \(\semnr{\var\in I}\eta = \bot = \bsemnr{k_1}{k_2}{\var\in
      I}\eta\) and our thesis hold. Otherwise
    \(\eta\var \cap \concr[\inte](I) = S \neq \emptyset\). In this
    case we are under the hypothesis that for all \(\var[y] \in \Var\)
    \(\semnr{\var\in I}\eta\var[y] \neq \top\), hence both
    \({\max(\semnr{\var\in I}\eta\var[y]) \neq +\infty}\) and
    \({\min(\semnr{\var\in I}\eta\var[y]) \neq -\infty}\) hold.
    Therefore by Lemma~\ref{le:incnr} and Lemma~\ref{le:decnr}, for
    all the variables \(\var[y] \in \Var\)
    \begin{align*}
      \max(S) = \max(\semnr{\var\in I}\eta\var) & \leq \max(\eta) + \bound{\var \in I}\\
      \min(S) = \min(\semnr{\var\in I}\eta\var) & \geq \min(\eta) - \lbound{\var \in I}
    \end{align*}
    which means that \(\abstr[k_1,k_2](S) = S\) and therefore
    \begin{equation*}
      \bsemnr{k_1}{k_2}{\var\in I}\eta\var = \abstr[k_1,k_2](\semnr{\var\in I}\eta\var) = \semnr{\var\in I}\eta\var
    \end{equation*}
    which means that our thesis is respected.

    \case{\(\var := k\)} In this case we have to prove that
    \begin{equation*}
      \forall \var[y] \in \Var \quad {\bsemnr{k_1}{k_2}{\var := k}\eta\var[y] \neq \top}
      \implies
      {\semnr{\var := k}\eta} = {\bsemnr{k_1}{k_2}{\var := k}\eta}
    \end{equation*}
    when \(k_1 \leq \min(\rho) - \nlbound{\var := k}\) and
    \(k_2 \geq \max(\rho) + \nbound{\var := k}\). % This follows from
    % the fact that if we consider \(\var[y] = \var\) then
    % \(\semnr{\var := k}\eta\var = \{k\}\), which is finite, and
    % \(\nlbound{\var := k} = \nbound{\var := k} = |k|\) this means that
    % \(k_1 \leq -|k|\) and \(k_2 \geq +|k|\), hence
    % \begin{equation*}
    %   {\bsemnr{k_1}{k_2}{\var := k}\eta\var} = \abstr[k_1,k_2]({\semnr{\var := k}\eta\var}) = {\semnr{\var := k}\eta\var}
    % \end{equation*}
    % and therefore for \(\var[y] = \var\) our thesis holds. For every
    % other \(\var[y] \neq \var\) it holds that
    % \begin{equation*}
    %   |\semnr{\var := k}\eta\var[y]| \neq \infty
    %   \implies
    %   \semnr{\var := k}\eta\var[y] = \eta\var[y]
    % \end{equation*}
    % and by hypothesis \(\eta \in \bbCnr{k_1}{k_2}\) for all
    % \(\bbCnr{k_1}{k_2}\) s.t.
    % \(\bCnr_{\com, \eta} \preceq \bbCnr{k_1}{k_2}\), which is our
    % case. Hence also in this case our thesis holds:
    % \begin{equation*}
    %   |\semnr{\var := k}\eta\var[y]| \neq \infty
    %   \implies
    %   \semnr{\var := k}\eta\var[y] =
    %   \abstr[k_1,k_2]({\semnr{\var := k}\eta\var[y]}) =
    %   {\bsemnr{k_1}{k_2}{\var := k}\eta\var[y]}
    % \end{equation*}
    This follows from the fact that we're under the hypothesis that
    \(\forall \var[y]\in\Var\)
    \(\bsemnr{k_1}{k_2}{\var:= k}\eta\var[y]\neq\top\), hence
    \begin{align*}
      \max(\semnr{\var:= k}\eta\var[y]) & \leq \max(\eta) + \bound{\var := k} = k_2  & \text{By Lemma~\ref{le:incnr}}\\
      \min(\semnr{\var:= k}\eta\var[y]) & \geq \min(\eta) - \lbound{\var := k} = k_1 & \text{By Lemma~\ref{le:decnr}}
    \end{align*}
    must be true, and therefore by definition of
    \(\bsemnr{k_1}{k_2}{\cdot}\)
    \begin{equation*}
      \bsemnr{k_1}{k_2}{\var := k}\eta = \abstr[k_1,k_2]\left(\semnr{\var := k}\eta\right) = \semnr{\var := k}\eta
    \end{equation*}
    which is our thesis.

    \case{\(\var := \var[y] + k\)} In this case we have to prove that
    \begin{equation*}
      \forall \var[w] \in \Var_{\com} \quad {\semnr{\var := \var[y] + k}\eta\var[w]} \neq \top
      \implies
      {\semnr{\var := \var[y] + k}\eta} = {\bsemnr{k_1}{k_2}{\var := \var[y] + k}\eta}
    \end{equation*}
    Similarly to the latter case, if \(\var[w] \neq \var\) it holds
    that \(\semnr{\var := \var[y] + k}\eta\var[w] = \eta\var[w]\), and
    since
    \(\eta \in \bCnr_{\var := \var[y] + k, \eta} \preceq
    \bbCnr{k_1}{k_2}\) it also holds that
    \(\min(\eta\var[w]) \geq k_1\) and \(\max(\eta\var[w]) \leq
    k_2\). Otherwise, if \(\var[w] = \var\)
    \begin{align*}
      \max(\semnr{\var := \var[y] + k}\eta\var) & \leq \max(\eta) + \bound{\var := \var[y] + k} & \text{by Lemma~\ref{le:incnr}} \\
      \min(\semnr{\var := \var[y] + k}\eta\var) & \geq \min(\eta) + \lbound{\var := \var[y] + k} & \text{by Lemma~\ref{le:decnr}}
    \end{align*}
    Therefore in every case each variable is inside the domain bounds
    \(k_1, k_2\), which means that by definition of
    \(\abstr[k_1,k_2]\) our thesis
    \begin{equation*}
      \forall \var[w] \in \Var \quad \bsemnr{k_1}{k_2}{\var := \var[y] + k}\eta\var[w] \neq \top \implies
      \semnr{\var := \var[y] + k}\eta =
      \abstr[k_1,k_2](\semnr{\var := \var[y] + k}\eta) =
      \bsemnr{k_1}{k_2}{\var := \var[y] + k}\eta
    \end{equation*}
    holds.

    \case{\(\com_1 \ndet \com_2\)} In this case we have to prove that
    for all \(\var \in \Var_{\com}\)
    \begin{equation*}
      \forall \var[y]\in\Var \quad \bsemnr{k_1}{k_2}{\com_1 \ndet \com_2}\eta\var[y] \neq \top
      \implies
      \semnr{\com_1 \ndet \com_2}\eta = \bsemnr{k_1}{k_2}{\com_1 \ndet\com_2}\eta
    \end{equation*}
    with \(k_1 \leq \min(\eta) - \nlbound{\com_1 \ndet \com_2}\) and
    \(k_2 \geq \max(\eta) + \nbound{\com_1 \ndet \com_2}\). First we
    can notice that since
    \(\bsemnr{k_1}{k_2}{\com_1 \ndet \com_2}\eta\var =
    \bsemnr{k_1}{k_2}{\com_1}\eta\var \cup
    \bsemnr{k_1}{k_2}{\com_2}\eta\var\) our hypothesis
    \({\bsemnr{k_1}{k_2}{\com_1 \ndet \com_2}\eta\var \neq \top}\)
    implies both \({\bsemnr{k_1}{k_2}{\com_1}\eta\var \neq \top}\) and
    \({\bsemnr{k_1}{k_2}{\com_2}\eta\var \neq \top}\). Hence by choice
    of \(k_1\) and \(k_2\) we can use the inductive hypothesis and
    state that
    \begin{align*}
      \semnr{\com_1}\eta\var & = \bsemnr{k_1}{k_2}{\com_1}\eta\var \\
      \semnr{\com_2}\eta\var & = \bsemnr{k_1}{k_2}{\com_2}\eta\var
    \end{align*}
    and by closure over \(\cup\)
    \begin{equation*}
      \semnr{\com_1 \ndet\com_2}\eta\var =
      \semnr{\com_1}\eta\var \cup \semnr{\com_2}\eta\var =
      \bsemnr{k_1}{k_2}{\com_1}\eta\var \cup \bsemnr{k_1}{k_2}{\com_2}\eta\var =
      \bsemnr{k_1}{k_2}{\com_1 \ndet\com_2}\eta\var
    \end{equation*}
    which is our thesis.

    \case{\(\com_1 \seq \com_2\)} In this case we have to prove that
    \begin{equation*}
      \forall \var[y]\in\Var \quad \bsemnr{k_1}{k_2}{\com_1\seq\com_2}\eta\var[y] \neq \top
      \implies
      \semnr{\com_1 \seq\com_2} \eta = \bsemnr{k_1}{k_2}{\com_1 \seq\com_2}\eta
    \end{equation*}
    for all \(k_1 \leq \min(\eta) -\nlbound{\com_1\seq\com_2}\) and
    \(k_2 \geq \max(\eta) + \nbound{\com_1\seq\com_2}\). First let's
    recall that
    \begin{equation*}
      \bsemnr{k_1}{k_2}{\com_1\seq\com_2}\eta\var = \bsemnr{k_1}{k_2}{\com_2}\left(\bsemnr{k_1}{k_2}{\com_1}\eta\right)(\var)
    \end{equation*}
    and we are under the hypothesis
    \(\forall \var[y] \in \Var \;
    \bsemnr{k_1}{k_2}{\com_1\seq\com_2}\eta\var[y] \neq \top\), which
    means that both the following hold
    \begin{align*}
      {\forall \var[y] \in \Var} \; \bsemnr{k_1}{k_2}{\com_1}\eta\var[y] & \neq \top \\
      {\forall \var[y] \in \Var} \; \bsemnr{k_1}{k_2}{\com_2}\eta'\var[y] & \neq \top
    \end{align*}
    where \(\eta' = \semnr{\com_1}\eta\).  By inductive hypothesis if
    for all \(\var[y] \in \Var_{\com}\)
    \(\semnr{\com_1}\eta\var[y] \neq \top\) then
    \(\semnr{\com_1}\eta\var = \bsemnr{k_1}{k_2}{\com_1}\eta\var\) for
    all \(k_1 \leq \min(\eta) - \nlbound{\com_1}\) and
    \(k_2 \geq \max(\eta) + \nbound{\com_2}\). We can now call and by
    inductive hypothesis again:
    \begin{equation*}
      \forall \var[y] \in \Var \quad \bsemnr{k_1}{k_2}{\com_2}\eta'\var \neq \top
      \implies
      \semnr{\com_2}\eta'\var = \bsemnr{k_1}{k_2}{\com_2}\eta'\var
    \end{equation*}
    for all \(k_1 \leq \min(\eta') - \nlbound{\com_2}\) and
    \(k_2 \geq \max(\eta') + \nbound{\com}\). Notice that
    \(\min(\eta') \geq \min(\eta) - \nlbound{\com_1}\) and
    \(\max(\eta') \leq \max(\eta) + \nbound{\com_1}\) and therefore we
    can chose
    \(k_1 \leq \min(\eta) - \nlbound{\com_1} - \nlbound{\com_2}\) and
    \(k_2 \geq \max(\eta) + \nbound{\com_1} + \nbound{\com_2}\) and
    notice that both inductive hypothesis hold, and therefore the
    following holds
    \begin{equation*}
      \forall \var[y] \in \Var \quad \bsemnr{k_1}{k_2}{\com_1\seq\com_2}\eta\var \neq \top
      \implies
      \semnr{\com_1\seq\com_2}\eta\var = \bsemnr{k_1}{k_2}{\com_1\seq\com_2}\eta\var
    \end{equation*}
    which is our thesis.
    
    \case{\(\fix\com\)} In this case we want to prove that
    \begin{equation*}
      \forall \var[y] \in \Var \quad \bsemnr{k_1}{k_2}{\fix\com}\eta\var \neq \top
      \implies
      \semnr{\fix\com}\eta = \bsemnr{k_1}{k_2}{\fix\com}\eta
    \end{equation*}
    for all \(k_1 \geq \min(\eta) - \nlbound{\fix\com}\) and
    \(k_2 \leq \max(\eta) + \nbound{\fix\com}\). Recall that by
    Lemma~\ref{le:soundnr} it always holds that
    \begin{equation*}
      \semnr{\fix\com}\eta \ovdot\subseteq \bsemnr{k_1}{k_2}{\fix\com}\eta
    \end{equation*}
    We have therefore to prove that 
    \begin{equation}\label{eq:geq}
      \forall \var\in\Var \quad \bsemnr{k_1}{k_2}{\fix\com}\eta\var \neq \top
      \implies
      \semnr{\fix\com}\eta \ovdot\supseteq \bsemnr{k_1}{k_2}{\fix\com}\eta
    \end{equation}
    for all \(k_1 \leq \min(\eta) - \nlbound{\fix\com}\) and
    \(k_2 \geq \max(\eta) + \nbound{\fix\com}\). To start notice that
    according to Lemma~\ref{le:sugar}
    \(\semnr{\fix\com}\eta = \semnr{\kleene{(\com\ndet\tru)}}\eta\),
    hence we can alternatively prove that
    \begin{equation*}
      \forall \var[y] \in \Var \bsemnr{k_1}{k_2}{\fix\com}\eta\var \neq \top
      \implies
      \semnr{\fix\com}\eta \supseteq \bigcup_{i\in\n} {\left(\bsemnr{k_1}{k_2}{\com \ndet \tru}\right)}^i\eta
    \end{equation*}
    which implies Equation~\ref{eq:geq}. To start we will initially
    prove that for every \(i\in\n\) it holds that
    \begin{equation*}
      \forall \var \in \Var\quad \semnr{\fix\com}\eta\var \neq \top
      \implies
      %
      \semnr{\fix\com}\eta\var \supseteq
      {\left(\bsemnr{k_1}{k_2}{\com \ndet \tru}\right)}^i\eta
    \end{equation*}
    to then prove the first one by closure over \(\cup\). We will
    prove it by induction on \(i\):
    \begin{description}
      
    \item[Case] (\(i=0\)). In this case we have to prove that
      \begin{equation*}
        \forall \var[y] \in \Var \quad \bsemnr{k_1}{k_2}{\fix\com}\eta\var[y] \neq \top
        \implies
        \semnr{\fix\com}\eta \supseteq \eta
      \end{equation*}
      We can notice that by definition of \(\semnr{\fix\com}\) the
      thesis holds.
      
    \item[Case] (\(i \implies i+1\)). In this case we have to prove
      that
      \begin{equation*}
        \forall \var \in \Var \quad \semnr{\fix\com}\eta\var \neq \top
        \implies
        \bsemnr{k_1}{k_2}{\fix\com}\eta \supseteq {\left(\bsemnr{k_1}{k_2}\com\ndet\tru\right)}^{i+1}\eta
      \end{equation*}
      First we can notice that
      \begin{align*}
        \semnr{\com\ndet\tru}(\semnr{\fix\com}\eta) & = \semnr{\com}(\semnr{\fix\com}\eta) \cup \semnr{\fix\com}\eta \\
                                                    & = \semnr{\com}(\lfp(\lambda \mu . \eta \cup \semnr{\com}\mu)) \cup \semnr{\fix\com}\eta \\
                                                    & = \eta \cup \semnr{\com}(\lfp(\lambda \mu . \eta \cup \semnr{\com}\mu)) \cup \semnr{\fix\com}\eta & \text{since } \eta \subseteq \lfp(\lambda \mu . \eta \cup \semnr{\com}\mu)\\
                                                    & = (\lambda \mu . \eta \cup \semnr{\com}\mu)(\lfp(\lambda \mu . \eta \cup \semnr{\com}\mu)) \cup \semnr{\fix\com}\eta \\
                                                    & = (\lfp(\lambda \mu . \eta \cup \semnr{\com}\mu)) \cup \semnr{\fix\com}\eta & \text{by def.\ of } \lfp\\
                                                    & = \semnr{\fix\com}\eta \cup \semnr{\fix\com}\eta \\
                                                    & = \semnr{\fix\com}\eta
      \end{align*}
      % can notice that since by hypothesis
      % \(|\semnr{\fix\com}\eta\var| \neq \infty\), we can leverage
      % Lemma~\ref{le:incnr} and state that for all
      % \(\var\in \Var_{\com}\) the follwing hold
      % \begin{align*}
      %   \max(\semnr{\fix\com}\eta\var) & \leq \max(\eta) + \bound{\fix\com} \\
      %   \min(\semnr{\fix\com}\eta\var) & \geq \min(\eta) - \lbound{\fix\com}
      % \end{align*}
      Now we can preliminarly observe that by calling
      \(\beta = \semnr{\fix\com}\eta\)
      \begin{equation}\label{eq:comfixbound}
        |\beta\var| \neq\infty \implies \semnr{\com\ndet\tru}\beta\var \supseteq \bsemnr{k_1}{k_2}{\com\ndet\tru}\beta\var
      \end{equation}
      \begin{align*}
        \max(\semnr{\com\ndet\tru}\beta\var) & \leq \max(\beta) + \bound{\com\ndet\tru} = \max(\beta) + \bound{\com} \\
                                             & \leq \max(\eta) + \bound{\fix\com} + \bound{\com} & \text{by Lemma~\ref{le:incnr}} \\
                                             & \leq \max(\eta) + (n+2)\bound{\com} \\
                                             & \leq \max(\eta) + (n+2)\nbound{\com} \\
                                             & \leq \max(\eta) + \nbound{\fix\com} = k_2
      \end{align*}
      similarly for the min value
      \begin{equation*}
        \min(\semnr{\com\ndet\tru}\beta\var) \geq \min(\eta) - \nlbound{\fix\com} = k_1
      \end{equation*}
      hence
      \begin{align*}
        \beta\var = \semnr{\com\ndet\tru}\beta\var & \supseteq \bsemnr{k_1}{k_2}{\com\ndet\tru}\beta\var & \text{by~\eqref{eq:comfixbound}}\\
                                                   & \supseteq \bsemnr{k_1}{k_2}{\com\ndet\tru}{\left(\bsemnr{k_1}{k_2}{\com\ndet\tru}\right)}^i\eta & \text{by induction on } i\\
                                                   & = {\left(\bsemnr{k_1}{k_2}{\com\ndet\tru}\right)}^{i+1}\eta
      \end{align*}
    \end{description}
    Hence our thesis, for all \(\var \in \Var_{\com}, i \in \n\)
    \begin{equation*}
      |\semnr{\fix\com}\eta\var| \neq \infty \implies
      % 
      \semnr{\fix\com}\eta\var \supseteq
      {\left(\bsemnr{k_1}{k_2}{\com\ndet\tru}\right)}^i\eta
    \end{equation*}
    holds.  We can now conclude by noticing that our original thesis
    \begin{equation*}
      |\semnr{\fix\com}\eta\var| \neq \infty \implies
      % 
      \semnr{\fix\com}\eta\var \supseteq
      \bigcup_{i\in\n}{\left(\bsemnr{k_1}{k_2}{\com\ndet\tru}\right)}^i\eta =
      \bsemnr{k_1}{k_2}{\fix\com}\eta\var
    \end{equation*}
    also holds.
  \end{inductive}
\end{proof}

The latter theorem is a result similar to the result for the interval
domain with Theorem~\ref{th:bounded}. In its essence it states that
when doing static analysis with abstract interpretation using the non
relational collecting domain \(\bCnr\) for some program
\(\com\in\imp\) and an initial environment \(\eta \in \bCnr\) we can
consider a bounded version of the domain \(\bbCnr{k_1}{k_2}\) with
\(k_1 = \min(\eta) - \nlbound{\com}\) and
\(k_2 = \max(\eta) + \nbound{\com}\) (hence computed accordingly to
\(\com\) and \(\eta\)). Each variable \(\var \in \Var_{\com}\) either
% Possiamo fare analisi statica secondo la semantica induttiva di cui
% sopra. Se la variabile ha come risultato un set finito, questo è
% garantito essere nel reticolo ristretto. Altrimenti, dato che
% l'analisi è comunque sound per il teorema di prima, la semantica
% induttiva farà divergere la variabile a \(\top\), dato che è
% l'elemento del reticolo che identifica tutto \(\z\), ovvero l'unico
% set infinito che consideriamo.
