\section{Computing non-relational collecting semantics}\label{sec:computingnonrel}

In the following section we follow the same scheme used in
\secref{sec:computing} in order to prove that we can also bound
the non relational collecting domain to ensure convergence while
obtaining the most precise interval.  To start, we rely on
Definition~\ref{def:minmax} of \(\min\) and \(\max\) values of an
abstract environment \(\rho\) to bound the non relational collecting
domain \(\bCnr\) in this way:

\begin{definition}[Bounded non-relational collecting domain]
  We define
  \(\bbCnr{k_1}{k_2} \defin \Var_{\com} \to \bounded{\poset[*]{\z}}{k_1}{k_2}\) where
  \begin{equation*}
    \bposet[*]{k_1}{k_2}{\z} = \{S \subseteq \z \mid S \neq \emptyset \land \forall x \in S \quad k_1 \leq x \leq k_2\} \cup \{\top\}
  \end{equation*}
\end{definition}
Notice that contrary to \(\binte{k_1}{k_2}\) we have no way of
representing a diverging element. For bounded intervals we had the
\(\interval{a}{+\infty}\) and \(\interval{-\infty}{b}\) elements with
\(a,b\in\z\), but for arbitrary subsets of \(z\) we have to rely on a
smashed \(\top\) element.

\medskip

\noindent
We can already observe that by definition there are no infinite
ascending nor descending chains, as every chain is bounded by above
by some \(k_2 \in \z\) and below by some \(k_1\in\z\). Moreover, there
is a Galois connection between this abstract domain and its unbounded
counterpart \(\poset\z\). First let's define the concretization and
abstraction maps

\begin{definition}\label{def:abstrnrb}
  Let \(k_1,k_2\in\z\) s.t.\ \(k_1 \leq k_2\). We define a
  concretization map
  \(\concr[k_1,k_2] : \bposet[*]{k_1}{k_2}{\z} \to \poset[*]{\z}\) as
  the identity function
  \begin{equation*}
    \concr[k_1,k_2] = \id
  \end{equation*}
  similarly we define an abstraction map
  \(\abstr[k_1,k_2] : \poset[*]{\z} \to \bposet[*]{k_1}{k_2}{\z}\) in
  the following way
  \begin{equation*}
    \abstr[k_1,k_2](S) = \begin{cases}
      S & \text{if } \inf(S) \geq k_1 \land \sup(S) \leq k_2 \\
      \top & \text{otherwise}
    \end{cases}
  \end{equation*}
\end{definition}

\begin{lemma}
  Given \(k_1, k_2 \in \z\) s.t.\ \(k_1\leq k_2\).
  \begin{equation*}
    \tuple{\poset[*]\z, \subseteq} \galois{\abstr[k_1,k_2]}{\id} \tuple{\bposet[*]{k_1}{k_2}{\z}, \subseteq}
  \end{equation*}
  i.e.,
  \(\tuple{\abstr[k_1,k_2], \poset[*]{\z},
    {\bposet[*]{k_1}{k_2}{\z}}, \id}\) is a Galois connection.
\end{lemma} 

\begin{proof}
  The proof consists in showing that \(\concr[k_1,k_2]\) and
  \(\abstr[k_1,k_2]\) satisfy the properties of
  Theorem~\ref{th:galoisprop}:
  \begin{enumerate}[label={(\arabic*)}]
  \item\label{itemone} \(\abstr[k_1,k_2]\), \(\id\) are monotonic;
  \item\label{itemtwo} \(\id \conc \abstr[k_1, k_2]\) is extensive, i.e.,
    \(\sigma \subseteq \abstr[k_1,k_2](\sigma)\) for all
    \(\sigma \in \poset[*]{\z}\);
  \item\label{itemthree} \(\abstr[k_1,k_2] \conc\concr\) is reductive, i.e.,
    \(\abstr[k_1,k_2](\sigma_b) \subseteq \sigma_b\) for all
    \(\sigma_b \in \bposet[*]{k_1}{k_2}{\z}\).
  \end{enumerate}
  To start let's prove~\ref{itemone}. Of course \(\id\) is monotone by
  definition. For \(\abstr[k_1,k_2]\) we have to prove that given any
  \(\sigma, \tau \in \poset[*]{\z}\) s.t.\ \(\sigma \subseteq \tau\)
  it holds that
  \(\abstr[k_1,k_2](\sigma) \subseteq \abstr[k_1,k_2](\tau)\). Notice
  that since \(\sigma \subseteq \tau\) it holds that
  \(\max(\sigma) \leq \max(\tau)\) and
  \(\min(\sigma) \geq \min(\tau)\), which means by
  Definition~\ref{def:abstrnrb}
  \(\abstr[k_1,k_2]{\sigma} \subseteq \abstr[k_1,k_2]{\tau}\), which
  is our thesis.

  \medskip

  \noindent
  Both~\ref{itemtwo} and~\ref{itemthree} follow from
  Definition~\ref{def:abstrnrb}. For~\ref{itemtwo} for all
  \(\sigma \in \poset[*]{\z}\) either
  \(\abstr[k_1,k_2]({\sigma}) = \sigma\) or
  \(\abstr[k_1,k_2]({\sigma}) = \top\), hence in both cases
  \(\sigma \subseteq \abstr[k_1,k_2]({\sigma})\)
  holds. For~\ref{itemthree}, for all
  \(\sigma_b \in \bposet[*]{k_1}{k_2}{\z}\) it holds that
  \(\max(\sigma_b) \leq k_2\) and \(\min(\sigma_b) \geq k_1\), hence
  \begin{equation}\label{eq:equality2}
    \abstr[k_1,k_2]({\sigma_b}) = \sigma_b
  \end{equation}
  and therefore \(\abstr[k_1,k_2]({\sigma_b}) \subseteq \sigma_b\)
  holds.  Moreover,~\eqref{eq:equality2} means that for all
  \(\sigma_b \in \bposet[*]{k_1}{k_2}{\z}\) that
  \(\abstr[k_1,k_2] \conc \id = \id\), which means by
  Definition~\ref{def:insertion} that we formed a Galois insertion:
  \begin{equation*}
    \tuple{\poset[*]{\z}, \subseteq}
    \galoiS{\abstr[k_1,k_2]}{\id}
    \tuple{\bposet[*]{k_1}{k_2}{\z}, \subseteq}
    \qedhere
  \end{equation*}
\end{proof}
Notice that since \(\bCnr\) and \(\bbCnr{k_1}{k_2}\) are respectively
the point-wise lifting of \(\poset[*]{\z}\) and
\(\bposet[*]{k_1}{k_2}{\z}\) there is also a Galois insertion between
them:
\begin{equation*}
  \tuple{\bCnr, \ovdot\subseteq}
  \galoiS{\dabstr[k_1,k_2]}{\id}
  \tuple{\bbCnr{k_1}{k_2}, \ovdot\subseteq}
\end{equation*}
Where
\(\dabstr[k_1,k_2](\eta) = \lambda \var . \abstr[k_1,k_2](\eta\var)\).
Since we have a Galois connection between the non relational
collecting domain \(\bCnr\) and its bounded version
\(\bbCnr{k_1}{k_2}\) we can define an abstract inductive semantics
which is sound by construction:
\begin{definition}[\textbf{Abstract bounded non relational collecting semantics}]
  Let \(k_1, k_2 \in \z\) s.t.\ \(k_1\leq k_2\).  We define basic
  expressions over the bounded non relational collecting semantics
  \({\absem[\bbCnr{k_1}{k_2}]{\cdot} : \expr \to \bbCnr{k_1}{k_2} \to
    \bbCnr{k_1}{k_2}}\) as
  \begin{equation*}
    \absem[\bbCnr{k_1}{k_2}]{\com[e]} \defin \dabstr[k_1,k_2] \conc \absem[\bCnr]{\com[e]}
  \end{equation*}
  i.e.\ the best correct abstraction.
\end{definition}

\begin{lemma}[\textbf{Bounded non relational collecting is sound}]\label{le:soundnr}
  Let \(k_1, k_2 \in \z\) s.t.\ \(k_1\leq k_2\). For all
  \(\abstract\eta \in \bbCnr{k_1}{k_2}\) it holds that
  \begin{equation*}
    \left(\semnr{\com} \conc \id \right)\abstract\eta \ovdot\subseteq \left(\id \conc \bsemnr{k_1}{k_2}{\com}\right) \abstract\eta
  \end{equation*}
  i.e., \(\bsemnr{k_1}{k_2}{\cdot}\) is sound w.r.t.\ \(\semnr{\cdot}\).
\end{lemma}

\begin{proof}
  The proof follows from the fact that \(\bsemnr{k_1}{k_2}{\cdot}\) is
  defined as the bca on basic expressions over \(\bCnr\) and there is
  a Galois connection
  \begin{equation*}
    \tuple{\bCnr, \ovdot\subseteq} \galoiS{\abstr[k_1,k_2]}{\id} \tuple{\bbCnr{k_1}{k_2}, \ovdot\subseteq}
  \end{equation*}
  Hence by Lemma~\ref{le:bcainducessoundness} our thesis 
  \begin{equation*}
    \left(\semnr{\com} \conc \id \right) \abstract\eta \ovdot\subseteq \left(\id \conc \bsemnr{k_1}{k_2}{\com}\right) \abstract\eta
  \end{equation*}
  holds.
\end{proof}

By using \(k_1, k_2\) properly, we can introduce a notion of order
between bounded non relational collecting domain. More in detail,
given \(a,b,c,d \in \z\) s.t.\ \(a\leq b\) and \(c \leq d\). Then
\(\preceq\) is a relation order s.t.
\begin{equation*}
  \bbCnr{a}{b} \preceq \bbCnr{c}{d} \iff a \leq c \land d \leq b
\end{equation*}

We bounded our analysis the same way we did with interval analysis in
Definition~\ref{def:boundedint}. This initial solution however has a
problem. Consider the following code snippet:
\begin{lstlisting}[language=Imp,caption=Snippet where bounded analysis diverges from the unbounded counterpart, label=code3]
  x := 0
  y := 0
  while (x < 1)
    x := x + 1
    y := y + 2
  if (y = 1)
    x := 2
\end{lstlisting}
before entering the \textcolor{blue}{\texttt{while}} loop variables
are bounded to singleton sets
\(\var \mapsto \{0\}, \var[y] \mapsto \{0\}\). Non-relational
collecting semantics can infer for \(\var\) the set
\(\var\mapsto \{0,1\}\), since the condition to enter the loop filters
for \(\var \mapsto \{0\}\). For \(\var[y]\) however the guard does not
filter anything (since the condition is on \(\var\) and the domain is
non-relational). Hence after the loop non-relational collecting
analysis infers the set of even numbers \(\mathbb{P}\):
\(\var[y] \mapsto \mathbb{P}\). Since the set is infinite at some
point it will surely exceed the program bound, which is a number in
\(\n\). Hence the bounded analysis, after the loop can infer
\(\var\mapsto\{0,1\}, \var[y] \mapsto \top\). The last
\textcolor{blue}{\texttt{if}} is however where the two analysis
diverge (while remaining sound): the original non-relational
collecting before the \textcolor{blue}{\texttt{if}} infers
\([\var\mapsto\{0,1\}, \var[y]\mapsto\mathbb{P}]\), hence the filter
\(\var[y] = 1\) filters \(\bot\) and therefore after the
\textcolor{blue}{\texttt{if}} the invariant remains
\([\var\mapsto\{0,1\}, \var[y]\mapsto\mathbb{P}]\). The bounded
analysis however filters \([\var\mapsto\{0,1\}, \var[y]\mapsto\{1\}]\)
and therefore after the \textcolor{blue}{\texttt{if}} the inferred
invariant is \([\var\mapsto\{0,1,2\}, \var[y]\mapsto\top]\), hence
diverging. The idea is that by being non-relational and smashing all
infinite elements of \(\poset{\z}\) to \(\top\) the loss of
information does not allow to infer the correct invariant even for
variables with finite mappings.

Our guess is that it is possible to infer the precise infinite
invariant, since all the information used to generate it are
syntactically available: previous work on such matter is from James
Worrell in~\cite{Lefaucheux2024}, which however deals with Presburger
arithmetics (which are outside of scope in this thesis).

For this reason our approach consists in smashing the \(\top\) element
of our analysis. Remember that the original problem we want to solve
(roughly) is the non-termination of the analysis,

che accade quando l'analisi di una variabile diverge all'interno di
un loop usando le iterazioni di kleene.

\begin{definition}[Smashed \(\top\) non realtional collecting]
  Let
  \begin{equation*}
    \bposet{k_1}{k_2}{\z} \defin \{S \subseteq \z \mid S \neq \emptyset \land \forall x \in S \quad k_1 \leq x \leq k_2\}.
  \end{equation*}
  We define \(\btbCnr{k_1}{k_2}\) as
  \begin{equation*}
    \btbCnr{k_1}{k_2} \defin (\Var \to \bposet{k_1}{k_2}{\z}) \cup \{\bot, \top\}
  \end{equation*}
\end{definition}

we can build a Galois connection with \(\bbCnr{k_1}{k_2}\) for some
fixed \(k_1, k_2 \in \z\):

\begin{definition}
  Let \(k_1, k_2 \in \z\) s.t.\ \(k_1 \leq k_2\),
  \(\eta \in \bbCnr{k_1}{k_2}\) and
  \(\overline\eta \in \btbCnr{k_1}{k_2}\). Then the abstraction map
  \({\tabstr[k_1,k_2]} : \bbCnr{k_1}{k_2} \to \btbCnr{k_1}{k_2}\) is
  defined as
  \begin{equation*}
    {\tabstr[k_1,k_2]}(\eta) = \begin{cases}
      \top & \text{if } \exists\var\in\Var \text{ s.t. } \eta\var = \top \\
      \eta & \text{otherwise}
    \end{cases}
  \end{equation*}
  while concretization map
  \({\tconcr[k_1,k_2]} : \btbCnr{k_1}{k_2} \to \bbCnr{k_1}{k_2}\)
  is defined as
  \begin{align*}
    \tconcr[k_1,k_2](\top) & = \lambda \var \in \Var . \top \\
    \tconcr[k_1,k_2](\overline\eta) & = \overline\eta
  \end{align*}
\end{definition}

We can now define base expressions based on the bca with the bounded
non relational collecting semantics:

\begin{definition}
  Let \(\com[e] \in \expr\). The semantics of base expressions over
  \(\btbCnr{k_1}{k_2}\) is defined as
  \begin{equation*}
    \absem[\btbCnr{k_1}{k_2}]{\com[e]} \defin {\tabstr[k_1,k_2]}\conc \absem[\bbCnr{k_1}{k_2}]{\com[e]}
  \end{equation*}
  i.e., the bca on the semantics of base expressions on bounded
  non-relational collecting analysis.
\end{definition}
Once again, \(\semi[\btbCnr{k_1}{k_2}]{\cdot}\) is defined accordingly
to the abstract inductive semantics of Definition~\ref{def:abstrsem}.
Notice that contrary to latter definition of \(\bbCnr{k_1}{k_2}\) in
this case we have a smashed top element. The idea is that whenever a
variable diverges we infer that the whole precise analysis diverges,
in order to solve Problem~\ref{problem1} and decide analysis
termination.  For simplicity, from now on we will refer to
\(\semi[\btbCnr{k_1}{k_2}]{\cdot}\) as \(\btsemnr{k_1}{k_2}{\cdot}\).

We preliminarly prove a simple but useful property of
\(\btsemnr{k_1}{k_2}{\cdot}\): it preserves the \(\top\) element.

\begin{lemma}[\(\btsemnr{k_1}{k_2}{\cdot}\) preserves \(\top\)]\label{le:btsemnrtop}
  Let \(k_1, k_2 \in \z\) s.t.\ \(k_1 \leq k_2\) and \(\com\in\imp\)
  \begin{equation*}
    \btsemnr{k_1}{k_2}{\com}\top = \top
  \end{equation*}
\end{lemma}

\begin{proof}
  We proceed by induction on the program \(\com\) to prove that
  \begin{equation*}
    \btsemnr{k_1}{k_2}{\com}\top = \top
  \end{equation*}
  \begin{inductive}
    \case{\(\var\in I\)} In this case
    \begin{align*}
      \btsemnr{k_1}{k_2}{\var \in I}\top & = (\tabstr[k_1,k_2] \conc \dabstr[k_1,k_2]) (\semnr{\var\in I}(\lambda \var[y] . \top)) \\
      & = (\tabstr[k_1,k_2] \conc \dabstr[k_1,k_2]) f
    \end{align*}
    where
    \begin{equation*}
      f (\var[y]) = \begin{cases}
        \concr[k_1,k_2](I) & \text{if } \var[y] = \var \\
        \top & \text{otherwise}
      \end{cases}
    \end{equation*}
    Now notice that for all \(\var[y] \neq \var\) it holds that
    \(\dabstr[k_1,k_2](f)(\var[y]) = \top\), hence
    \((\tabstr[k_1,k_2] \conc \dabstr[k_1,k_2])(f) = \top\), which is
    our thesis.

    \case{\(\var := k\)} In this case
    \begin{align*}
      \btsemnr{k_1}{k_2}{\var := k}\top & = (\tabstr[k_1,k_2] \conc \dabstr[k_1,k_2]) (\semnr{\var:= k}(\lambda \var[y] . \top)) \\
      & = (\tabstr[k_1,k_2] \conc \dabstr[k_1,k_2]) f
    \end{align*}
    where
    \begin{equation*}
      f (\var[y]) = \begin{cases}
        \{k\} & \text{if } \var[y] = \var \\
        \top & \text{otherwise}
      \end{cases}
    \end{equation*}
    Now notice that for all \(\var[y] \neq \var\) it holds that
    \(\dabstr[k_1,k_2](f)(\var[y]) = \top\), hence
    \((\tabstr[k_1,k_2] \conc \dabstr[k_1,k_2])(f) = \top\), which is
    our thesis.

    \case{\(\var := \var[y] + k\)} In this case
    \begin{align*}
      \btsemnr{k_1}{k_2}{\var := \var[y] + k}\top & = (\tabstr[k_1,k_2] \conc \dabstr[k_1,k_2]) (\semnr{\var := \var[y] + k}(\lambda \var[w] . \top)) \\
                                                  & = (\tabstr[k_1,k_2] \conc \dabstr[k_1,k_2]) (\lambda \var[w] . \top) & \text{since } \top + k = \top \\
                                                  & = \top
    \end{align*}

    \case{\(\com_1 \ndet \com_2\)} In this case
    \begin{align*}
      \btsemnr{k_1}{k_2}{\com_1\ndet\com_2}\top & = \btsemnr{k_1}{k_2}{\com_1}\top \ovdot\cup \btsemnr{k_1}{k_2}{\com_2}\top \\
                                                & = \top \ovdot\cup \top & \text{By inductive hypothesis} \\
                                                & = \top
    \end{align*}
    \case{\(\com_1 \seq \com_2\)} In this case
    \begin{align*}
      \btsemnr{k_1}{k_2}{\com_1\seq\com_2}\top & = \btsemnr{k_1}{k_2}{\com_2}\left(\btsemnr{k_1}{k_2}{\com_1}\top\right) \\
                                               & = \btsemnr{k_1}{k_2}{\com_2}\top & \text{By induction on }\com_1 \\
                                               & = \top & \text{By induction on }\com_2
    \end{align*}
    \case{\(\fix\com\)} In this case
    \begin{align*}
      \btsemnr{k_1}{k_2}{\fix\com}\top & = \lfp\left(\lambda \mu . \top \ovdot\cup \btsemnr{k_1}{k_2}{\com}\mu\right) \ovdot\supseteq \top & \text{By definition of }\lfp \\
                                       & = \top & \text{By definition of }\top
    \end{align*}
  \end{inductive}
\end{proof}

\begin{theorem}
  Let \(\com\in\imp\) be a program. Then, for all finitely supported
  \(\eta \in \btbCnr{k_1}{k_2}\) and \(k_1, k_2 \in \z\) s.t.\
  \(\bCnr_{\com,\eta} \preceq \bbCnr{k_1}{k_2}\), i.e.,
  \(k_1 \leq \min(\eta) - \nlbound{\com}\) and
  \(k_2 \geq \max(\eta) + \nbound{\com}\) then
  \begin{equation*}
    \btsemnr{k_1}{k_2}{\com}\eta \neq \top
    \quad
    \implies
    \quad
    \semnr{\com}\eta = \btsemnr{k_1}{k_2}{\com}\eta
  \end{equation*}
  i.e., if the analysis over \(\btbCnr{k_1}{k_2}\) does not diverge,
  then the analysis over \(\bCnr\) converges to the same result.
\end{theorem}

\begin{proof}
  The proof will proceed by induction on the program \(\com\),
  covering first the base cases of \(\expr\) expressions and then the
  inductive cases of \(\imp\). Notice that because of
  Lemma~\ref{le:soundnr}
  \begin{equation*}
    \semnr{\com}\tconcr[k_1,k_2](\overline\eta)
    \ovdot\subseteq
    \semi[\bbCnr{k_1}{k_2}]{\com}\tconcr[k_1,k_2](\overline\eta)
    \ovdot\subseteq
    \tconcr[k_1,k_2](\btsemnr{k_1}{k_2}{\com}\overline\eta)
    % \ovdot\subseteq \tconcr[k_1,k_2]\left(\btsemnr{k_1}{k_2}{\com}\eta\right)
  \end{equation*}
  already holds for every \(k_1, k_2 \in \z\) s.t.\ \(k_1\leq k_2\)
  and \(\overline\eta \in \btbCnr{k_1}{k_2}\), hence what we have to
  prove for every case is that
  \begin{equation*}
    \btsemnr{k_1}{k_2}{\com}\eta \neq \top \implies \semnr{\com} \eta \ovdot\supseteq \btsemnr{k_1}{k_2}{\com}\eta
  \end{equation*}
  First notice that it cannot be \(\overline\eta = \top\), otherwise
  by Lemma~\ref{le:btsemnrtop} \(\btsemnr{k_1}{k_2}{\com}\top = \top\)
  and therefore the hypothesis
  \(\btsemnr{k_1}{k_2}{\com}\top \neq \top\) is not
  respceted. Furthermore, notice that
  \(\btsemnr{k_1}{k_2}{\com}\overline\eta \neq \top\) implies that
  \(\tconcr[k_1,k_2](\btsemnr{k_1}{k_2}{\com}\overline\eta) =
  \btsemnr{k_1}{k_2}{\com}\overline\eta\), due to the definition of
  \(\tconcr[k_1,k_2]\).
  \begin{inductive}
    \case{\(\com[e]\)} In this case we have to prove that
    \begin{equation*}
      \btsemnr{k_1}{k_2}{\com[e]}\overline{\eta} \neq \top \implies
      \semnr{\com[e]}\tconcr[k_1,k_2](\overline\eta) = \tconcr[k_1,k_2](\btsemnr{k_1}{k_2}{\com[e]}\overline\eta)
    \end{equation*}
    First, if \(\overline\eta = \bot\) we can notice that
    \begin{equation*}
      (\tabstr[k_1k_2] \conc \dabstr[k_1,k_2] \conc \semnr{\com[e]})\bot
      = \bot =
      \semnr{\com[e]}\tconcr[k_1,k_2](\bot)
    \end{equation*}
    which is our thesis.

    The last case is when \(\top \neq \overline\eta\neq\bot\) and
    therefore for all \(\var\in\Var\)
    \(\overline\eta\var \in \bposet{k_1}{k_2}{\z}\). In this case by
    Lemma~\ref{le:incnr} and Lemma~\ref{le:decnr} for all
    \(\var[y]\in\Var\) both
    \begin{align*}
      \max(\semnr{\com[e]}\tconcr[k_1,k_2](\overline\eta)\var[y]) & \leq \max(\tconcr[k_1,k_2](\overline\eta)) + \bound{\com[e]} \leq \max(\tconcr[k_1,k_2](\overline\eta)) + \nbound{\com[e]} = k_2 \\
      \min(\semnr{\com[e]}\tconcr[k_1,k_2](\overline\eta)\var[y]) & \geq \min(\tconcr[k_1,k_2](\overline\eta)) - \lbound{\com[e]} \geq \min(\tconcr[k_1,k_2](\overline\eta)) - \nlbound{\com[e]} = k_1
    \end{align*}
    hence by definition of \(\dabstr[k_1,k_2]\) and
    \(\tabstr[k_1,k_2]\)
    \begin{equation*}
      \left(\tabstr[k_1,k_2] \conc \dabstr[k_1,k_2]\right)\left(\semnr{\com[e]}\tconcr[k_1,k_2](\overline\eta)\right)
      =
      \semnr{\com[e]}\tconcr[k_1,k_2](\overline\eta)
    \end{equation*}
    which is our thesis.

    \case{\(\com_1 \ndet \com_2\)} In this case we have to prove that
    \begin{equation*}
      \btsemnr{k_1}{k_2}{\com_1 \ndet \com_2}\eta \neq \top
      \implies
      \semnr{\com_1 \ndet \com_2}\eta = \btsemnr{k_1}{k_2}{\com_1 \ndet\com_2}\eta
    \end{equation*}
    with \(k_1 \leq \min(\eta) - \nlbound{\com_1 \ndet \com_2}\) and
    \(k_2 \geq \max(\eta) + \nbound{\com_1 \ndet \com_2}\). First we
    can notice that since
    \(\btsemnr{k_1}{k_2}{\com_1 \ndet \com_2}\eta\var =
    \btsemnr{k_1}{k_2}{\com_1}\eta\var \cup
    \btsemnr{k_1}{k_2}{\com_2}\eta\var\) our hypothesis
    \({\btsemnr{k_1}{k_2}{\com_1 \ndet \com_2}\eta\var \neq \top}\)
    implies both \({\btsemnr{k_1}{k_2}{\com_1}\eta\var \neq \top}\) and
    \({\btsemnr{k_1}{k_2}{\com_2}\eta\var \neq \top}\). Hence by choice
    of \(k_1\) and \(k_2\) we can use the inductive hypothesis and
    state that
    \begin{align*}
      \semnr{\com_1}\eta\var & = \btsemnr{k_1}{k_2}{\com_1}\eta\var \\
      \semnr{\com_2}\eta\var & = \btsemnr{k_1}{k_2}{\com_2}\eta\var
    \end{align*}
    and by closure over \(\cup\)
    \begin{equation*}
      \semnr{\com_1 \ndet\com_2}\eta\var =
      \semnr{\com_1}\eta\var \cup \semnr{\com_2}\eta\var =
      \btsemnr{k_1}{k_2}{\com_1}\eta\var \cup \btsemnr{k_1}{k_2}{\com_2}\eta\var =
      \btsemnr{k_1}{k_2}{\com_1 \ndet\com_2}\eta\var
    \end{equation*}
    which is our thesis.

    \case{\(\com_1 \seq \com_2\)} In this case we have to prove that
    \begin{equation*}
      \btsemnr{k_1}{k_2}{\com_1\seq\com_2}\eta \neq \top
      \implies
      \semnr{\com_1 \seq\com_2} \eta = \btsemnr{k_1}{k_2}{\com_1 \seq\com_2}\eta
    \end{equation*}
    for all \(k_1 \leq \min(\eta) -\nlbound{\com_1\seq\com_2}\) and
    \(k_2 \geq \max(\eta) + \nbound{\com_1\seq\com_2}\). First let's
    recall that
    \begin{equation*}
      \btsemnr{k_1}{k_2}{\com_1\seq\com_2}\overline\eta
      =
      \btsemnr{k_1}{k_2}{\com_2}\left(\btsemnr{k_1}{k_2}{\com_1}\overline\eta\right)
    \end{equation*}
    and we are under the hypothesis
    \(\btsemnr{k_1}{k_2}{\com_1\seq\com_2}\overline\eta \neq \top\),
    which means that
    \(\btsemnr{k_1}{k_2}{\com_2}\overline\eta\neq \top \neq
    \btsemnr{k_1}{k_2}{\com_2}\overline\eta'\) where
    \(\overline\eta' = \btsemnr{k_1}{k_2}{\com_1}\overline\eta\),
    otherwise by Lemma~\ref{le:btsemnrtop} we would contraddict the
    hypothesis
    \(\btsemnr{k_1}{k_2}{\com_1\ndet\com_2}\overline\eta\neq\top\).
    Then, by inductive hypothesis
    \(\semnr{\com_1}\overline\eta =
    \btsemnr{k_1}{k_2}{\com_1}\overline\eta\) for all
    \(k_1 \leq \min(\eta) - \nlbound{\com_1}\) and
    \(k_2 \geq \max(\eta) + \nbound{\com_2}\). We can now call
    \(\overline\eta' = \btsemnr{k_1}{k_2}{\com_1}\overline\eta\) and
    by inductive hypothesis again:
    \begin{equation*}
      \btsemnr{k_1}{k_2}{\com_2}\eta' \neq \top
      \implies
      \semnr{\com_2}\eta' = \btsemnr{k_1}{k_2}{\com_2}\eta'
    \end{equation*}
    for all \(k_1 \leq \min(\eta') - \nlbound{\com_2}\) and
    \(k_2 \geq \max(\eta') + \nbound{\com}\). Notice that
    \(\min(\eta') \geq \min(\eta) - \nlbound{\com_1}\) and
    \(\max(\eta') \leq \max(\eta) + \nbound{\com_1}\) and therefore we
    can chose
    \(k_1 \leq \min(\eta) - \nlbound{\com_1} - \nlbound{\com_2}\) and
    \(k_2 \geq \max(\eta) + \nbound{\com_1} + \nbound{\com_2}\). Since
    both inductive hypothesis hold, then following holds
    \begin{equation*}
      \btsemnr{k_1}{k_2}{\com_1\seq\com_2}\eta \neq \top
      \implies
      \semnr{\com_1\seq\com_2}\eta = \btsemnr{k_1}{k_2}{\com_1\seq\com_2}\eta
    \end{equation*}
    which is our thesis.
    
    \case{\(\fix\com\)} In this case we want to prove that
    \begin{equation*}
      \btsemnr{k_1}{k_2}{\fix\com}\overline\eta \neq \top
      \implies
      \semnr{\fix\com}\overline\eta = \btsemnr{k_1}{k_2}{\fix\com}\overline\eta
    \end{equation*}
    for all \(k_1 \geq \min(\overline\eta) - \nlbound{\fix\com}\) and
    \(k_2 \leq \max(\overline\eta) + \nbound{\fix\com}\). Recall that by
    Lemma~\ref{le:soundnr} it always holds that
    \begin{equation*}
      \semnr{\fix\com}\overline\eta \ovdot\subseteq \btsemnr{k_1}{k_2}{\fix\com}\overline\eta
    \end{equation*}
    We have therefore to prove that 
    \begin{equation}\label{eq:geq}
      \btsemnr{k_1}{k_2}{\fix\com}\overline\eta \neq \top
      \implies
      \semnr{\fix\com}\overline\eta \ovdot\supseteq \btsemnr{k_1}{k_2}{\fix\com}\overline\eta
    \end{equation}
    for all \(k_1 \leq \min(\overline\eta) - \nlbound{\fix\com}\) and
    \(k_2 \geq \max(\overline\eta) + \nbound{\fix\com}\). To start notice that
    according to Lemma~\ref{le:sugar}
    \(\semnr{\fix\com}\overline\eta = \semnr{\kleene{(\com\ndet\tru)}}\overline\eta\),
    hence we can alternatively prove that
    \begin{equation*}
      \btsemnr{k_1}{k_2}{\fix\com}\overline\eta\neq \top
      \implies
      \semnr{\fix\com}\overline\eta
      \ovdot\supseteq
      \bigcup_{i\in\n} {\left(\btsemnr{k_1}{k_2}{\com \ndet \tru}\right)}^i\overline\eta
    \end{equation*}
    which implies Equation~\ref{eq:geq}. To start we will initially
    prove that for every \(i\in\n\) it holds that
    \begin{equation*}
      \semnr{\fix\com}\overline\eta \neq \top
      \implies
      %
      \semnr{\fix\com}\overline\eta \ovdot\supseteq
      {\left(\btsemnr{k_1}{k_2}{\com \ndet \tru}\right)}^i\overline\eta
    \end{equation*}
    to then prove the first one by closure over \(\cup\). We will
    prove it by induction on \(i\):
    \begin{description}
      
    \item[Case] (\(i=0\)). In this case we have to prove that
      \begin{equation*}
        \btsemnr{k_1}{k_2}{\fix\com}\overline\eta \neq \top
        \implies
        \semnr{\fix\com}\overline\eta \ovdot\supseteq \overline\eta
      \end{equation*}
      We can notice that by definition of \(\semnr{\fix\com}\) the
      thesis holds.
      
    \item[Case] (\(i \implies i+1\)). In this case we have to prove
      that
      \begin{equation*}
        \semnr{\fix\com}\overline\eta \neq \top
        \implies
        \semnr{\fix\com}\overline\eta \supseteq {\left(\btsemnr{k_1}{k_2}\com\ndet\tru\right)}^{i+1}\overline\eta
      \end{equation*}
      First we can notice that
      \begin{align*}
        \semnr{\com\ndet\tru}(\semnr{\fix\com}\overline\eta) & = \semnr{\com}(\semnr{\fix\com}\overline\eta) \cup \semnr{\fix\com}\overline\eta \\
                                                    & = \semnr{\com}(\lfp(\lambda \mu . \overline\eta \cup \semnr{\com}\mu)) \cup \semnr{\fix\com}\overline\eta \\
                                                    & = \overline\eta \cup \semnr{\com}(\lfp(\lambda \mu . \overline\eta \cup \semnr{\com}\mu)) \cup \semnr{\fix\com}\overline\eta & \text{since } \overline\eta \subseteq \lfp(\lambda \mu . \overline\eta \cup \semnr{\com}\mu)\\
                                                    & = (\lambda \mu . \overline\eta \cup \semnr{\com}\mu)(\lfp(\lambda \mu . \overline\eta \cup \semnr{\com}\mu)) \cup \semnr{\fix\com}\overline\eta \\
                                                    & = (\lfp(\lambda \mu . \overline\eta \cup \semnr{\com}\mu)) \cup \semnr{\fix\com}\overline\eta & \text{by def.\ of } \lfp\\
                                                    & = \semnr{\fix\com}\overline\eta \cup \semnr{\fix\com}\overline\eta \\
                                                    & = \semnr{\fix\com}\overline\eta
      \end{align*}
      % can notice that since by hypothesis
      % \(|\semnr{\fix\com}\overline\eta\var| \neq \infty\), we can leverage
      % Lemma~\ref{le:incnr} and state that for all
      % \(\var\in \Var_{\com}\) the follwing hold
      % \begin{align*}
      %   \max(\semnr{\fix\com}\overline\eta\var) & \leq \max(\overline\eta) + \bound{\fix\com} \\
      %   \min(\semnr{\fix\com}\overline\eta\var) & \geq \min(\overline\eta) - \lbound{\fix\com}
      % \end{align*}
      Now we can preliminarly observe that by calling
      \(\beta = \semnr{\fix\com}\overline\eta\)
      \begin{equation}\label{eq:comfixbound}
       % \forall \var\in\Var \quad  \beta\var \neq\top \implies 
       \semnr{\com\ndet\tru}\beta \supseteq \btsemnr{k_1}{k_2}{\com\ndet\tru}\beta
      \end{equation}
      In fact, for all \(\var\in \Var\)
      \begin{align*}
        \max(\semnr{\com\ndet\tru}\beta\var) & \leq \max(\beta) + \bound{\com\ndet\tru} = \max(\beta) + \bound{\com} \\
                                             & \leq \max(\overline\eta) + \bound{\fix\com} + \bound{\com} & \text{by Lemma~\ref{le:incnr}} \\
                                             & \leq \max(\overline\eta) + (n+2)\bound{\com} \\
                                             & \leq \max(\overline\eta) + (n+2)\nbound{\com} \\
                                             & \leq \max(\overline\eta) + \nbound{\fix\com} = k_2
      \end{align*}
      similarly for the min value
      \begin{equation*}
        \min(\semnr{\com\ndet\tru}\beta\var) \geq \min(\overline\eta) - \nlbound{\fix\com} = k_1
      \end{equation*}
      hence
      \begin{align*}
        \beta = \semnr{\com\ndet\tru}\beta & \supseteq \btsemnr{k_1}{k_2}{\com\ndet\tru}\beta & \text{by~\eqref{eq:comfixbound}}\\
                                           & \supseteq \btsemnr{k_1}{k_2}{\com\ndet\tru}{\left(\btsemnr{k_1}{k_2}{\com\ndet\tru}\right)}^i\overline\eta & \text{by induction on } i\\
                                           & = {\left(\btsemnr{k_1}{k_2}{\com\ndet\tru}\right)}^{i+1}\overline\eta
      \end{align*}
    \end{description}
    Hence our thesis, for all \(i \in \n\)
    \begin{equation*}
      \btsemnr{k_1}{k_2}{\fix\com}\overline\eta \top \implies
      % 
      \semnr{\fix\com}\overline\eta \supseteq
      {\left(\btsemnr{k_1}{k_2}{\com\ndet\tru}\right)}^i\overline\eta
    \end{equation*}
    holds.  We can now conclude by noticing that our original thesis
    \begin{equation*}
      \btsemnr{k_1}{k_2}{\fix\com}\overline\eta \neq \top \implies
      % 
      \semnr{\fix\com}\overline\eta \supseteq
      \bigcup_{i\in\n}{\left(\btsemnr{k_1}{k_2}{\com\ndet\tru}\right)}^i\overline\eta =
      \btsemnr{k_1}{k_2}{\fix\com}\overline\eta
    \end{equation*}
    also holds.
  \end{inductive}
\end{proof}

The latter theorem is a result similar to the result for the interval
domain with Theorem~\ref{th:bounded}. In its essence it states that
when doing static analysis with abstract interpretation using the non
relational collecting domain \(\bCnr\) for some program
\(\com\in\imp\) and an initial environment \(\eta \in \bCnr\) we can
consider a bounded version of the domain \(\bbCnr{k_1}{k_2}\) with
\(k_1 = \min(\eta) - \nlbound{\com}\) and
\(k_2 = \max(\eta) + \nbound{\com}\) (hence computed accordingly to
\(\com\) and \(\eta\)). Each variable \(\var \in \Var_{\com}\) either
% Possiamo fare analisi statica secondo la semantica induttiva di cui
% sopra. Se la variabile ha come risultato un set finito, questo è
% garantito essere nel reticolo ristretto. Altrimenti, dato che
% l'analisi è comunque sound per il teorema di prima, la semantica
% induttiva farà divergere la variabile a \(\top\), dato che è
% l'elemento del reticolo che identifica tutto \(\z\), ovvero l'unico
% set infinito che consideriamo.
